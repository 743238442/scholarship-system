# 高校奖学金管理系统数据库设计文档

## 1. 文档概述

### 1.1 文档目的
本文档基于《高校奖学金管理系统需求说明书》、《高校奖学金管理系统概要设计文档》和《高校奖学金管理系统详细设计文档》，专门针对系统的数据库设计进行详细说明，为数据库开发、优化和维护提供技术指导。

### 1.2 适用范围
本数据库设计文档适用于：
- 数据库管理员（DBA）
- 后端开发人员
- 系统架构师
- 运维人员

### 1.3 设计原则
- **数据完整性**：确保数据的准确性和一致性
- **性能优化**：合理设计索引和表结构，提升查询性能
- **扩展性**：预留扩展空间，支持系统功能扩展
- **安全性**：确保敏感数据的安全存储和访问控制
- **标准化**：遵循数据库设计规范和命名约定

### 1.4 文档版本
- 版本：V1.0
- 创建日期：2024年
- 最后更新：2024年
- 数据库版本：PostgreSQL 13+

## 2. 数据库架构设计

### 2.1 数据库选型
- **主数据库**：PostgreSQL 13+
- **缓存数据库**：Redis 6+
- **数据库编码**：UTF8
- **排序规则**：zh_CN.UTF-8

### 2.2 数据库架构图
```
┌─────────────────────────────────────────────────────────┐
│                   应用服务层                            │
│                   (Application)                         │
├─────────────────────────────────────────────────────────┤
│                   数据访问层                            │
│              (Data Access Layer)                       │
│                 Spring Data JPA                        │
├─────────────────────────────────────────────────────────┤
│                   缓存层                                │
│                    Redis                              │
│              (Session & Cache)                         │
├─────────────────────────────────────────────────────────┤
│                   数据库层                              │
│                 PostgreSQL                            │
│              (Primary Database)                        │
└─────────────────────────────────────────────────────────┘
```

### 2.3 数据库命名规范
- **数据库名**：小写字母，下划线分隔
- **表名**：tbl_前缀 + 小写字母，下划线分隔
- **字段名**：小写字母，下划线分隔
- **索引名**：idx_前缀 + 表名 + 字段名
- **约束名**：ck_前缀（检查约束），fk_前缀（外键约束），pk_前缀（主键约束）
- **视图名**：v_前缀 + 描述性名称
- **函数名**：fn_前缀 + 描述性名称

## 3. 数据表设计

### 3.1 数据库ER图
```
┌─────────────┐     ┌─────────────────┐     ┌──────────────┐
│    User     │────▶│   Student       │◀────│  Scholarship  │
│   用户      │     │   学生          │     │  奖学金类型   │
├─────────────┤     ├─────────────────┤     ├──────────────┤
│ id          │     │ id              │     │ id           │
│ username    │     │ user_id (FK)    │     │ name         │
│ password    │     │ student_no      │     │ amount       │
│ role        │     │ name            │     │ condition    │
│ email       │     │ gender          │     │ description  │
└─────────────┘     │ college         │     └──────────────┘
                    │ major           │            │
                    │ class           │            │
                    │ contact         │            │
                    └─────────────────┘            │
                              │                    │
                              │              ┌──────────────┐
                              │              │   Review     │
                              │              │   评审记录    │
                              │              ├──────────────┤
                              └──────────────│ id           │
                                             │ student_id   │
                                             │ scholarship_id│
                                             │ reviewer_id  │
                                             │ opinion      │
                                             │ result       │
                                             │ review_date  │
                                             └──────────────┘
                                                      │
                                                      │
                                             ┌──────────────┐
                                             │Announcement │
                                             │   公示      │
                                             ├──────────────┤
                                             │ id           │
                                             │ content      │
                                             │ start_date   │
                                             │ end_date     │
                                             │ status       │
                                             └──────────────┘
```

### 3.2 数据表详细设计

#### 3.2.1 用户表 (tbl_user)
**表功能**：存储系统用户基本信息，支持学生和管理员两种角色

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 用户ID，主键自增 |
| username | VARCHAR(50) | UNIQUE, NOT NULL | | 用户名，唯一非空 |
| password | VARCHAR(255) | NOT NULL | | 密码，加密存储 |
| email | VARCHAR(100) | UNIQUE | | 邮箱地址，唯一 |
| phone | VARCHAR(20) | | | 手机号码 |
| role | VARCHAR(20) | NOT NULL | | 角色(admin/student/teacher) |
| is_active | BOOLEAN | | true | 是否激活 |
| last_login_at | TIMESTAMP | | | 最后登录时间 |
| password_changed_at | TIMESTAMP | | CURRENT_TIMESTAMP | 密码修改时间 |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | | CURRENT_TIMESTAMP | 更新时间 |
| created_by | BIGINT | | | 创建人ID |
| updated_by | BIGINT | | | 更新人ID |
| version | INTEGER | | 0 | 版本号（乐观锁） |

**索引设计**：
```sql
CREATE INDEX idx_user_username ON tbl_user(username);
CREATE INDEX idx_user_email ON tbl_user(email);
CREATE INDEX idx_user_role ON tbl_user(role);
CREATE INDEX idx_user_is_active ON tbl_user(is_active);
```

#### 3.2.2 学生表 (tbl_student)
**表功能**：存储学生详细信息，关联用户表

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 学生ID，主键自增 |
| user_id | BIGINT | FOREIGN KEY | | 关联用户ID |
| student_no | VARCHAR(20) | UNIQUE, NOT NULL | | 学号，唯一非空 |
| name | VARCHAR(50) | NOT NULL | | 姓名，非空 |
| gender | CHAR(1) | CHECK | | 性别(M/F) |
| birth_date | DATE | | | 出生日期 |
| id_card | VARCHAR(18) | UNIQUE | | 身份证号，唯一 |
| college | VARCHAR(100) | NOT NULL | | 学院，非空 |
| major | VARCHAR(100) | NOT NULL | | 专业，非空 |
| class | VARCHAR(50) | NOT NULL | | 班级，非空 |
| grade | VARCHAR(10) | | | 年级 |
| contact | VARCHAR(100) | | | 联系方式 |
| emergency_contact | VARCHAR(100) | | | 紧急联系人 |
| address | TEXT | | | 家庭地址 |
| avatar_url | VARCHAR(500) | | | 头像URL |
| enrollment_date | DATE | | CURRENT_DATE | 入学日期 |
| graduation_date | DATE | | | 毕业日期 |
| is_graduated | BOOLEAN | | false | 是否已毕业 |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | | CURRENT_TIMESTAMP | 更新时间 |
| created_by | BIGINT | | | 创建人ID |
| updated_by | BIGINT | | | 更新人ID |
| version | INTEGER | | 0 | 版本号（乐观锁） |

**索引设计**：
```sql
CREATE INDEX idx_student_user_id ON tbl_student(user_id);
CREATE INDEX idx_student_no ON tbl_student(student_no);
CREATE INDEX idx_student_college ON tbl_student(college);
CREATE INDEX idx_student_major ON tbl_student(major);
CREATE INDEX idx_student_grade ON tbl_student(grade);
```

#### 3.2.3 奖学金类型表 (tbl_scholarship_type)
**表功能**：存储奖学金类型配置信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 奖学金类型ID |
| name | VARCHAR(100) | NOT NULL | | 奖学金名称 |
| code | VARCHAR(20) | UNIQUE, NOT NULL | | 奖学金代码 |
| category | VARCHAR(50) | NOT NULL | | 奖学金类别 |
| amount | DECIMAL(10,2) | NOT NULL | | 奖学金金额 |
| currency | VARCHAR(10) | | 'CNY' | 货币单位 |
| condition | TEXT | | | 评定条件 |
| description | TEXT | | | 详细描述 |
| requirements | TEXT | | | 申请要求 |
| application_start_date | DATE | | | 申请开始日期 |
| application_end_date | DATE | | | 申请结束日期 |
| review_start_date | DATE | | | 评审开始日期 |
| review_end_date | DATE | | | 评审结束日期 |
| announcement_date | DATE | | | 公示日期 |
| is_public | BOOLEAN | | true | 是否公开 |
| is_active | BOOLEAN | | true | 是否启用 |
| max_recipients | INTEGER | | | 最大获奖人数 |
| sort_order | INTEGER | | 0 | 排序序号 |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | | CURRENT_TIMESTAMP | 更新时间 |
| created_by | BIGINT | | | 创建人ID |
| updated_by | BIGINT | | | 更新人ID |
| version | INTEGER | | 0 | 版本号（乐观锁） |

**索引设计**：
```sql
CREATE INDEX idx_scholarship_code ON tbl_scholarship_type(code);
CREATE INDEX idx_scholarship_category ON tbl_scholarship_type(category);
CREATE INDEX idx_scholarship_active ON tbl_scholarship_type(is_active);
CREATE INDEX idx_scholarship_dates ON tbl_scholarship_type(application_start_date, application_end_date);
```

#### 3.2.4 评审记录表 (tbl_review)
**表功能**：存储奖学金申请和评审记录

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 评审记录ID |
| student_id | BIGINT | FOREIGN KEY | | 学生ID |
| scholarship_type_id | BIGINT | FOREIGN KEY | | 奖学金类型ID |
| reviewer_id | BIGINT | | | 评审人ID |
| review_status | VARCHAR(20) | NOT NULL | 'pending' | 评审状态 |
| comments | VARCHAR(1000) | | | 评审意见 |
| academic_year | VARCHAR(20) | NOT NULL | '2024-2025' | 学年 |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | | CURRENT_TIMESTAMP | 更新时间 |
| created_by | BIGINT | | | 创建人ID |
| updated_by | BIGINT | | | 更新人ID |
| version | INTEGER | | 0 | 版本号（乐观锁） |

**约束设计**：
```sql
ALTER TABLE tbl_review 
ADD CONSTRAINT ck_review_status 
CHECK (review_status IN ('pending', 'approved', 'rejected'));

ALTER TABLE tbl_review 
ADD CONSTRAINT uk_review_student_scholarship_year 
UNIQUE(student_id, scholarship_type_id, academic_year);
```

**索引设计**：
```sql
CREATE INDEX idx_review_student ON tbl_review(student_id);
CREATE INDEX idx_review_scholarship ON tbl_review(scholarship_type_id);
CREATE INDEX idx_review_reviewer ON tbl_review(reviewer_id);
CREATE INDEX idx_review_status ON tbl_review(review_status);
CREATE INDEX idx_review_academic_year ON tbl_review(academic_year);
```

#### 3.2.5 公示表 (announcements)
**表功能**：存储公示公告信息

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 公示ID |
| title | VARCHAR(200) | NOT NULL | | 公示标题 |
| content | TEXT | NOT NULL | | 公示内容 |
| published_by | BIGINT | NOT NULL | | 发布人ID |
| published_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 发布时间 |
| deleted | BOOLEAN | NOT NULL | false | 是否删除（软删除标志） |
| deleted_at | TIMESTAMP | | | 删除时间 |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | | CURRENT_TIMESTAMP | 更新时间 |

**约束设计**：
```sql
-- 无特定约束
```

**索引设计**：
```sql
CREATE INDEX idx_announcement_published_at ON announcements(published_at);
CREATE INDEX idx_announcement_deleted ON announcements(deleted);
CREATE INDEX idx_announcement_published_by ON announcements(published_by);
```

**软删除实现说明**：
- 使用`deleted`字段作为软删除标志，默认为false
- 当记录被删除时，`deleted`字段设为true，`deleted_at`记录删除时间
- 查询时通过`deleted = false`条件过滤已删除记录
- 软删除功能通过Repository层的自定义方法实现，如`findByDeletedIsFalse()`和`findByIdAndDeletedIsFalse()`

#### 3.2.6 学业记录表 (tbl_academic_record)
**表功能**：存储学生学业成绩记录

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 学业记录ID |
| student_id | BIGINT | FOREIGN KEY | | 学生ID |
| academic_year | VARCHAR(20) | NOT NULL | | 学年 |
| semester | VARCHAR(10) | NOT NULL | | 学期 |
| course_code | VARCHAR(20) | | | 课程代码 |
| course_name | VARCHAR(100) | NOT NULL | | 课程名称 |
| course_credit | DECIMAL(3,1) | NOT NULL | | 课程学分 |
| course_score | DECIMAL(5,2) | | | 课程分数 |
| course_grade | VARCHAR(10) | | | 课程等级 |
| gpa | DECIMAL(3,2) | | | 单科GPA |
| is_retake | BOOLEAN | | false | 是否重修 |
| retake_score | DECIMAL(5,2) | | | 重修分数 |
| teacher_name | VARCHAR(50) | | | 任课教师 |
| course_category | VARCHAR(50) | | | 课程类别 |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | | CURRENT_TIMESTAMP | 更新时间 |
| created_by | BIGINT | | | 创建人ID |
| updated_by | BIGINT | | | 更新人ID |
| version | INTEGER | | 0 | 版本号（乐观锁） |

**索引设计**：
```sql
CREATE INDEX idx_academic_student ON tbl_academic_record(student_id);
CREATE INDEX idx_academic_year_semester ON tbl_academic_record(academic_year, semester);
CREATE INDEX idx_academic_gpa ON tbl_academic_record(gpa);
CREATE INDEX idx_academic_credit ON tbl_academic_record(course_credit);
CREATE INDEX idx_academic_course ON tbl_academic_record(course_code, course_name);
```

#### 3.2.7 系统配置表 (tbl_system_config)
**表功能**：存储系统配置参数

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 配置ID |
| config_key | VARCHAR(100) | UNIQUE, NOT NULL | | 配置键 |
| config_value | TEXT | | | 配置值 |
| config_type | VARCHAR(20) | | 'string' | 配置类型 |
| description | TEXT | | | 配置描述 |
| is_public | BOOLEAN | | false | 是否公开 |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | | CURRENT_TIMESTAMP | 更新时间 |

**约束设计**：
```sql
ALTER TABLE tbl_system_config 
ADD CONSTRAINT ck_config_type 
CHECK (config_type IN ('string', 'integer', 'boolean', 'json'));
```

#### 3.2.8 操作日志表 (tbl_operation_log)
**表功能**：记录用户操作日志，用于审计和安全监控

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | BIGSERIAL | PRIMARY KEY | | 日志ID |
| user_id | BIGINT | FOREIGN KEY | | 用户ID |
| username | VARCHAR(50) | | | 用户名 |
| operation | VARCHAR(100) | NOT NULL | | 操作名称 |
| resource_type | VARCHAR(50) | | | 资源类型 |
| resource_id | VARCHAR(100) | | | 资源ID |
| request_method | VARCHAR(10) | | | 请求方法 |
| request_url | VARCHAR(500) | | | 请求URL |
| request_params | JSONB | | | 请求参数 |
| response_status | INTEGER | | | 响应状态 |
| response_message | TEXT | | | 响应消息 |
| ip_address | INET | | | IP地址 |
| user_agent | TEXT | | | 用户代理 |
| execution_time | INTEGER | | | 执行时间(毫秒) |
| created_at | TIMESTAMP | | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**：
```sql
CREATE INDEX idx_log_user ON tbl_operation_log(user_id);
CREATE INDEX idx_log_operation ON tbl_operation_log(operation);
CREATE INDEX idx_log_resource ON tbl_operation_log(resource_type, resource_id);
CREATE INDEX idx_log_created_at ON tbl_operation_log(created_at);
CREATE INDEX idx_log_ip_address ON tbl_operation_log(ip_address);
```

## 4. 视图设计

### 4.1 学生综合信息视图 (v_student_comprehensive)
**视图功能**：提供学生的综合信息视图，包含基本信息、学业统计和申请统计

```sql
CREATE VIEW v_student_comprehensive AS
SELECT 
    s.id,
    s.student_no,
    s.name,
    s.gender,
    s.college,
    s.major,
    s.class,
    s.grade,
    s.contact,
    u.username,
    u.email,
    u.role,
    u.is_active,
    s.enrollment_date,
    s.is_graduated,
    -- 学业统计
    COUNT(DISTINCT ar.id) as course_count,
    COALESCE(AVG(ar.gpa), 0) as avg_gpa,
    COALESCE(SUM(ar.course_credit), 0) as total_credits,
    COALESCE(MAX(ar.gpa), 0) as highest_gpa,
    -- 申请统计
    COUNT(DISTINCT r.id) as application_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'approved' THEN r.id END) as approved_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'rejected' THEN r.id END) as rejected_count,
    COUNT(DISTINCT CASE WHEN r.application_status = 'submitted' THEN r.id END) as submitted_count,
    -- 时间字段
    u.last_login_at,
    s.created_at,
    s.updated_at
FROM tbl_student s
LEFT JOIN tbl_user u ON s.user_id = u.id
LEFT JOIN tbl_academic_record ar ON s.id = ar.student_id
LEFT JOIN tbl_review r ON s.id = r.student_id
GROUP BY s.id, s.student_no, s.name, s.gender, s.college, s.major, s.class, s.grade, s.contact, 
         u.username, u.email, u.role, u.is_active, s.enrollment_date, s.is_graduated,
         u.last_login_at, s.created_at, s.updated_at;
```

### 4.2 奖学金评审汇总视图 (v_scholarship_summary)
**视图功能**：提供奖学金申请和评审的汇总统计信息

```sql
CREATE VIEW v_scholarship_summary AS
SELECT 
    st.id as scholarship_type_id,
    st.name as scholarship_name,
    st.code as scholarship_code,
    st.category,
    st.amount,
    st.currency,
    st.application_start_date,
    st.application_end_date,
    st.announcement_date,
    st.is_active,
    -- 申请统计
    COUNT(DISTINCT r.id) as total_applications,
    COUNT(DISTINCT CASE WHEN r.application_status = 'submitted' THEN r.id END) as submitted_count,
    COUNT(DISTINCT CASE WHEN r.application_status = 'under_review' THEN r.id END) as under_review_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'approved' THEN r.id END) as approved_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'rejected' THEN r.id END) as rejected_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'pending' THEN r.id END) as pending_count,
    -- 分数统计
    COALESCE(AVG(r.total_score), 0) as avg_score,
    COALESCE(MAX(r.total_score), 0) as highest_score,
    COALESCE(MIN(r.total_score), 0) as lowest_score,
    COALESCE(AVG(r.academic_score), 0) as avg_academic_score,
    COALESCE(AVG(r.conduct_score), 0) as avg_conduct_score,
    COALESCE(AVG(r.extra_score), 0) as avg_extra_score,
    -- 时间统计
    MIN(r.submitted_at) as first_submission_date,
    MAX(r.reviewed_at) as last_review_date,
    MAX(r.created_at) as last_application_date
FROM tbl_scholarship_type st
LEFT JOIN tbl_review r ON st.id = r.scholarship_type_id
GROUP BY st.id, st.name, st.code, st.category, st.amount, st.currency,
         st.application_start_date, st.application_end_date, st.announcement_date, st.is_active;
```

### 4.3 公示信息视图 (v_announcement_active)
**视图功能**：提供当前有效的公示信息

```sql
CREATE VIEW v_announcement_active AS
SELECT 
    id,
    title,
    summary,
    type,
    priority,
    is_top,
    start_date,
    end_date,
    publish_date,
    view_count,
    tags,
    created_by,
    published_at
FROM tbl_announcement
WHERE is_active = true 
    AND is_public = true
    AND (start_date IS NULL OR start_date <= CURRENT_DATE)
    AND (end_date IS NULL OR end_date >= CURRENT_DATE)
ORDER BY is_top DESC, priority DESC, publish_date DESC;
```

## 5. 存储过程设计

### 5.1 计算学生GPA (fn_calculate_student_gpa)
**功能**：计算指定学生在指定学年/学期的GPA

```sql
CREATE OR REPLACE FUNCTION fn_calculate_student_gpa(
    p_student_id BIGINT,
    p_academic_year VARCHAR(20),
    p_semester VARCHAR(10) DEFAULT NULL
)
RETURNS DECIMAL AS $$
DECLARE
    total_credits DECIMAL(10,2) := 0;
    total_quality_points DECIMAL(10,2) := 0;
    calculated_gpa DECIMAL(3,2);
BEGIN
    -- 计算总学分和质量点数
    SELECT 
        COALESCE(SUM(ar.course_credit), 0) as credits,
        COALESCE(SUM(ar.course_credit * ar.gpa), 0) as quality_points
    INTO total_credits, total_quality_points
    FROM tbl_academic_record ar
    WHERE ar.student_id = p_student_id
        AND ar.academic_year = p_academic_year
        AND (p_semester IS NULL OR ar.semester = p_semester)
        AND ar.course_score >= 60; -- 及格成绩才计入GPA
    
    -- 计算GPA
    IF total_credits > 0 THEN
        calculated_gpa := ROUND(total_quality_points / total_credits, 2);
    ELSE
        calculated_gpa := 0;
    END IF;
    
    RETURN calculated_gpa;
END;
$$ LANGUAGE plpgsql;
```

### 5.2 生成评审编号 (fn_generate_review_number)
**功能**：为评审记录生成唯一的评审编号

```sql
CREATE OR REPLACE FUNCTION fn_generate_review_number(
    p_scholarship_type_id BIGINT,
    p_academic_year VARCHAR(20)
)
RETURNS VARCHAR(50) AS $$
DECLARE
    scholarship_code VARCHAR(20);
    year_code VARCHAR(10);
    sequence_number INTEGER;
    review_number VARCHAR(50);
BEGIN
    -- 获取奖学金代码
    SELECT code INTO scholarship_code 
    FROM tbl_scholarship_type 
    WHERE id = p_scholarship_type_id;
    
    IF scholarship_code IS NULL THEN
        RAISE EXCEPTION '奖学金类型不存在: %', p_scholarship_type_id;
    END IF;
    
    -- 获取年份代码
    year_code := SUBSTR(p_academic_year, 1, 4);
    
    -- 获取序列号
    SELECT COALESCE(MAX(
        CAST(SUBSTRING(review_no FROM '.*-(\d+)$') AS INTEGER)
    ), 0) + 1
    INTO sequence_number
    FROM tbl_review
    WHERE scholarship_type_id = p_scholarship_type_id
        AND academic_year = p_academic_year;
    
    -- 生成评审编号 (格式: 奖学金代码-年份-序号)
    review_number := scholarship_code || '-' || year_code || '-' || LPAD(sequence_number::TEXT, 4, '0');
    
    RETURN review_number;
END;
$$ LANGUAGE plpgsql;
```

### 5.3 批量更新学生GPA (sp_update_student_gpa_batch)
**功能**：批量更新指定学年的所有学生GPA

```sql
CREATE OR REPLACE PROCEDURE sp_update_student_gpa_batch(
    p_academic_year VARCHAR(20),
    p_semester VARCHAR(10) DEFAULT NULL
)
LANGUAGE plpgsql
AS $$
DECLARE
    student_record RECORD;
    calculated_gpa DECIMAL(3,2);
    updated_count INTEGER := 0;
BEGIN
    -- 遍历所有学生
    FOR student_record IN 
        SELECT DISTINCT s.id 
        FROM tbl_student s
        WHERE s.is_graduated = false
    LOOP
        -- 计算每个学生的GPA
        SELECT fn_calculate_student_gpa(
            student_record.id, 
            p_academic_year, 
            p_semester
        ) INTO calculated_gpa;
        
        -- 更新学业记录中的GPA
        UPDATE tbl_academic_record 
        SET gpa = calculated_gpa,
            updated_at = CURRENT_TIMESTAMP
        WHERE student_id = student_record.id
            AND academic_year = p_academic_year
            AND (p_semester IS NULL OR semester = p_semester);
        
        updated_count := updated_count + 1;
    END LOOP;
    
    -- 记录更新日志
    RAISE NOTICE '成功更新 % 名学生的GPA信息 (学年: %, 学期: %)', 
        updated_count, p_academic_year, COALESCE(p_semester, '全部');
END;
$$;
```

### 5.4 清理过期数据 (sp_cleanup_expired_data)
**功能**：清理系统中的过期数据和日志

```sql
CREATE OR REPLACE PROCEDURE sp_cleanup_expired_data(
    p_days_to_keep INTEGER DEFAULT 90
)
LANGUAGE plpgsql
AS $$
DECLARE
    cutoff_date TIMESTAMP;
    deleted_logs INTEGER := 0;
    deleted_old_announcements INTEGER := 0;
BEGIN
    -- 计算截止日期
    cutoff_date := CURRENT_DATE - INTERVAL '1 day' * p_days_to_keep;
    
    -- 清理过期的操作日志
    DELETE FROM tbl_operation_log 
    WHERE created_at < cutoff_date;
    
    GET DIAGNOSTICS deleted_logs = ROW_COUNT;
    
    -- 清理过期的非置顶公示（保留置顶公示）
    DELETE FROM tbl_announcement 
    WHERE is_top = false 
        AND is_active = false
        AND created_at < cutoff_date;
    
    GET DIAGNOSTICS deleted_old_announcements = ROW_COUNT;
    
    -- 清理临时文件相关的记录（如果需要）
    
    -- 记录清理日志
    RAISE NOTICE '数据清理完成 - 删除日志: % 条, 删除过期公示: % 条', 
        deleted_logs, deleted_old_announcements;
END;
$$;
```

## 6. 索引优化设计

### 6.1 复合索引设计
为了优化常用查询场景，设计以下复合索引：

```sql
-- 学生信息查询优化
CREATE INDEX idx_student_college_major ON tbl_student(college, major);
CREATE INDEX idx_student_grade_class ON tbl_student(grade, class);

-- 评审记录查询优化
CREATE INDEX idx_review_student_status ON tbl_review(student_id, review_status);
CREATE INDEX idx_review_scholarship_status ON tbl_review(scholarship_type_id, review_status);
CREATE INDEX idx_review_year_status ON tbl_review(academic_year, review_status);

-- 学业记录查询优化
CREATE INDEX idx_academic_student_year_semester ON tbl_academic_record(student_id, academic_year, semester);
CREATE INDEX idx_academic_year_semester_gpa ON tbl_academic_record(academic_year, semester, gpa);

-- 公示信息查询优化
CREATE INDEX idx_announcement_type_active ON tbl_announcement(type, is_active);
CREATE INDEX idx_announcement_dates_active ON tbl_announcement(start_date, end_date, is_active);
```

### 6.2 部分索引设计
针对特定条件的查询优化：

```sql
-- 仅对活跃用户的索引
CREATE INDEX idx_user_active_username ON tbl_user(username) WHERE is_active = true;

-- 仅对启用奖学金的索引
CREATE INDEX idx_scholarship_active_category ON tbl_scholarship_type(category) WHERE is_active = true;

-- 仅对已提交申请的索引
CREATE INDEX idx_review_submitted_student ON tbl_review(student_id) WHERE application_status = 'submitted';

-- 仅对置顶公示的索引
CREATE INDEX idx_announcement_top_date ON tbl_announcement(publish_date) WHERE is_top = true;
```

## 7. 数据库安全设计

### 7.1 访问控制
```sql
-- 创建应用用户
CREATE USER scholarship_app WITH PASSWORD 'your_secure_password';

-- 授予基本权限
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO scholarship_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO scholarship_app;

-- 限制敏感表访问
REVOKE ALL ON tbl_user FROM scholarship_app;
GRANT SELECT (id, username, email, role, is_active) ON tbl_user TO scholarship_app;
```

### 7.2 数据加密
```sql
-- 创建加密函数
CREATE OR REPLACE FUNCTION fn_encrypt_data(data TEXT)
RETURNS TEXT AS $$
BEGIN
    -- 使用PostgreSQL的pgcrypto扩展进行加密
    RETURN encode(encrypt(data::bytea, 'encryption_key', 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql;

-- 创建解密函数
CREATE OR REPLACE FUNCTION fn_decrypt_data(encrypted_data TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN convert_from(decrypt(decode(encrypted_data, 'base64'), 'encryption_key', 'aes'), 'UTF8');
END;
$$ LANGUAGE plpgsql;
```

### 7.3 审计追踪
```sql
-- 创建审计触发器函数
CREATE OR REPLACE FUNCTION fn_audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
    -- 记录操作日志
    INSERT INTO tbl_operation_log (
        user_id, username, operation, resource_type, resource_id,
        request_method, request_url, ip_address, created_at
    ) VALUES (
        COALESCE(current_setting('app.user_id', true)::BIGINT, 0),
        COALESCE(current_setting('app.username', true), 'system'),
        TG_OP,
        TG_TABLE_NAME,
        COALESCE(NEW.id::TEXT, OLD.id::TEXT),
        'POST',
        current_setting('app.request_url', true),
        inet_client_addr(),
        CURRENT_TIMESTAMP
    );
    
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- 为关键表创建审计触发器
CREATE TRIGGER audit_user_changes
    AFTER INSERT OR UPDATE OR DELETE ON tbl_user
    FOR EACH ROW EXECUTE FUNCTION fn_audit_trigger();

CREATE TRIGGER audit_student_changes
    AFTER INSERT OR UPDATE OR DELETE ON tbl_student
    FOR EACH ROW EXECUTE FUNCTION fn_audit_trigger();
```

## 8. 性能优化设计

### 8.1 分区表设计
对于大量历史数据的表考虑分区：

```sql
-- 学业记录表按学年分区
CREATE TABLE tbl_academic_record_partitioned (
    LIKE tbl_academic_record INCLUDING ALL
) PARTITION BY RANGE (academic_year);

-- 创建年度分区
CREATE TABLE tbl_academic_record_2023 PARTITION OF tbl_academic_record_partitioned
    FOR VALUES FROM ('2023') TO ('2024');

CREATE TABLE tbl_academic_record_2024 PARTITION OF tbl_academic_record_partitioned
    FOR VALUES FROM ('2024') TO ('2025');
```

### 8.2 查询优化建议

#### 8.2.1 常用查询优化
1. **学生信息查询**：
   ```sql
   -- 使用复合索引优化
   SELECT * FROM v_student_comprehensive 
   WHERE college = '计算机学院' AND major = '软件工程';
   ```

2. **奖学金申请统计**：
   ```sql
   -- 使用汇总视图
   SELECT * FROM v_scholarship_summary 
   WHERE category = '国家奖学金' AND is_active = true;
   ```

3. **GPA计算查询**：
   ```sql
   -- 使用预计算函数
   SELECT s.name, fn_calculate_student_gpa(s.id, '2023-2024') as gpa
   FROM tbl_student s
   WHERE s.is_graduated = false;
   ```

### 8.3 缓存策略
在应用层实现以下缓存策略：

1. **学生基本信息缓存**：缓存时间30分钟
2. **奖学金类型信息缓存**：缓存时间2小时
3. **系统配置信息缓存**：缓存时间1小时
4. **GPA计算结果缓存**：缓存时间24小时

## 9. 备份与恢复设计

### 9.1 备份策略
```bash
# 每日全量备份
pg_dump -h localhost -U postgres -d scholarship_management \
    --format=custom --compress=6 --verbose \
    --file=scholarship_backup_$(date +%Y%m%d).dump

# 保留最近30天的备份文件
find /backup/postgresql -name "scholarship_backup_*.dump" -mtime +30 -delete

# WAL日志归档（持续归档）
archive_mode = on
archive_command = 'cp %p /backup/wal_archive/%f'
```

### 9.2 恢复策略
```bash
# 全量恢复
pg_restore --host localhost --username postgres --dbname scholarship_management \
    --verbose --clean --no-owner --no-privileges \
    scholarship_backup_20241201.dump

# 点时间恢复（需要配置 WAL 日志）
recovery_target_time = '2024-12-01 15:30:00'
recovery_target_action = 'promote'
```

### 9.3 监控与维护
```sql
-- 数据库大小监控
SELECT 
    pg_size_pretty(pg_database_size('scholarship_management')) as db_size;

-- 表大小分析
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 索引使用情况分析
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

## 10. 实施建议

### 10.1 数据库初始化步骤
1. **创建数据库和用户**
2. **执行DDL脚本创建表结构**
3. **创建索引和约束**
4. **创建视图和存储过程**
5. **初始化基础数据**
6. **配置安全策略**
7. **设置监控和维护任务**

### 10.2 部署检查清单
- [ ] 数据库连接配置正确
- [ ] 用户权限设置合理
- [ ] 索引创建完成
- [ ] 存储函数部署成功
- [ ] 备份策略配置完成
- [ ] 监控告警设置正常
- [ ] 性能基线测试通过

### 10.3 运维建议
1. **定期监控**：数据库性能、连接数、存储空间
2. **定期维护**：VACUUM、ANALYZE、更新统计信息
3. **定期备份**：验证备份文件完整性
4. **安全审计**：定期检查用户权限和访问日志
5. **性能优化**：根据实际使用情况调整索引和查询
