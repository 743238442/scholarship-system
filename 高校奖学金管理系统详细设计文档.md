# 高校奖学金管理系统详细设计文档

## 1. 文档概述

### 1.1 文档目的
本文档基于《高校奖学金管理系统需求说明书》和《高校奖学金管理系统概要设计文档》，提供系统的详细设计说明，包括具体的类设计、数据库设计、接口设计、页面设计等，为系统开发提供详细的技术指导。

### 1.2 适用范围
本详细设计文档适用于：
- 系统开发人员
- 测试人员
- 项目管理人员
- 运维人员

### 1.3 文档版本
- 版本：V1.0
- 创建日期：2024年
- 最后更新：2024年

## 2. 系统架构详细设计

### 2.1 整体架构
系统采用经典的分层架构，各层职责明确，降低耦合度。

```
┌─────────────────────────────────────────────────────────┐
│                    前端表现层                           │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────┐│
│  │   学生管理页面   │ │  奖学金管理页面  │ │ 公示管理页面 ││
│  │   学业管理页面   │ │  系统设置页面    │ │   登录页面   ││
│  └─────────────────┘ └─────────────────┘ └─────────────┘│
│              Thymeleaf + Bootstrap 5 + jQuery           │
├─────────────────────────────────────────────────────────┤
│                    控制层 Controller                     │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────┐│
│  │StudentController│ │ScholarshipCont..│ │AnnounceCont.││
│  │AcademicController│ │ReviewController │ │AuthController││
│  │UserController   │ │SystemController │ │             ││
│  └─────────────────┘ └─────────────────┘ └─────────────┘│
│                   Spring MVC + Controller               │
├─────────────────────────────────────────────────────────┤
│                    业务服务层 Service                    │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────┐│
│  │StudentService   │ │ScholarshipServ. │ │AnnounceServ.││
│  │AcademicService  │ │ReviewService    │ │UserService  ││
│  │AuthService      │ │EmailService     │ │LogService   ││
│  └─────────────────┘ └─────────────────┘ └─────────────┘│
│                   Spring Boot + Service Layer           │
├─────────────────────────────────────────────────────────┤
│                   数据访问层 Repository                  │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────┐│
│  │StudentRepositor.│ │ScholarshipRepos.│ │AnnounceRep. ││
│  │AcademicRepositor│ │ReviewRepository │ │UserRepositor││
│  │JpaRepository    │ │CustomRepository │ │             ││
│  └─────────────────┘ └─────────────────┘ └─────────────┘│
│                  Spring Data JPA + Hibernate            │
├─────────────────────────────────────────────────────────┤
│                     数据存储层                           │
│            PostgreSQL 13+ + Redis Cache                 │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术栈详细配置

#### 2.2.1 后端技术栈
- **Spring Boot 3.1.5**: 应用框架
- **Spring MVC**: Web层框架
- **Spring Data JPA**: 数据访问框架
- **Spring Security**: 安全框架
- **Hibernate**: ORM框架
- **PostgreSQL 13+**: 主数据库
- **Redis**: 缓存数据库
- **Maven**: 项目构建工具
- **JDK 17**: Java开发环境

#### 2.2.2 前端技术栈
- **Thymeleaf 3.1**: 模板引擎
- **Bootstrap 5.3**: UI框架
- **jQuery 3.7**: JavaScript库
- **DataTables**: 数据表格插件
- **Chart.js**: 图表库
- **SweetAlert2**: 消息提示框

## 3. 数据库详细设计

### 3.1 数据库初始化脚本

#### 3.1.1 创建数据库
```sql
-- 创建数据库
CREATE DATABASE scholarship_management
    WITH OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'zh_CN.UTF-8'
    LC_CTYPE = 'zh_CN.UTF-8'
    TEMPLATE = template0;

-- 创建schema
CREATE SCHEMA IF NOT EXISTS public;
```

#### 3.1.2 数据库用户创建
```sql
-- 创建应用用户
CREATE USER scholarship_app WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE scholarship_management TO scholarship_app;
```

### 3.2 数据表详细设计

#### 3.2.1 用户表 (tbl_user)
```sql
CREATE TABLE tbl_user (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20),
    role VARCHAR(20) NOT NULL CHECK (role IN ('admin', 'student', 'teacher')),
    is_active BOOLEAN DEFAULT true,
    last_login_at TIMESTAMP,
    password_changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 0
);

-- 创建索引
CREATE INDEX idx_user_username ON tbl_user(username);
CREATE INDEX idx_user_email ON tbl_user(email);
CREATE INDEX idx_user_role ON tbl_user(role);
CREATE INDEX idx_user_is_active ON tbl_user(is_active);
```

#### 3.2.2 学生表 (tbl_student)
```sql
CREATE TABLE tbl_student (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES tbl_user(id),
    student_no VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(50) NOT NULL,
    gender CHAR(1) CHECK (gender IN ('M', 'F')),
    birth_date DATE,
    id_card VARCHAR(18) UNIQUE,
    college VARCHAR(100) NOT NULL,
    major VARCHAR(100) NOT NULL,
    class VARCHAR(50) NOT NULL,
    grade VARCHAR(10),
    contact VARCHAR(100),
    emergency_contact VARCHAR(100),
    address TEXT,
    avatar_url VARCHAR(500),
    enrollment_date DATE DEFAULT CURRENT_DATE,
    graduation_date DATE,
    is_graduated BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 0
);

-- 创建索引
CREATE INDEX idx_student_user_id ON tbl_student(user_id);
CREATE INDEX idx_student_no ON tbl_student(student_no);
CREATE INDEX idx_student_college ON tbl_student(college);
CREATE INDEX idx_student_major ON tbl_student(major);
CREATE INDEX idx_student_grade ON tbl_student(grade);
```

#### 3.2.3 奖学金类型表 (tbl_scholarship_type)
```sql
CREATE TABLE tbl_scholarship_type (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(20) UNIQUE NOT NULL,
    category VARCHAR(50) NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(10) DEFAULT 'CNY',
    condition TEXT,
    description TEXT,
    requirements TEXT,
    application_start_date DATE,
    application_end_date DATE,
    review_start_date DATE,
    review_end_date DATE,
    announcement_date DATE,
    is_public BOOLEAN DEFAULT true,
    is_active BOOLEAN DEFAULT true,
    max_recipients INTEGER,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 0
);

-- 创建索引
CREATE INDEX idx_scholarship_code ON tbl_scholarship_type(code);
CREATE INDEX idx_scholarship_category ON tbl_scholarship_type(category);
CREATE INDEX idx_scholarship_active ON tbl_scholarship_type(is_active);
CREATE INDEX idx_scholarship_dates ON tbl_scholarship_type(application_start_date, application_end_date);
```

#### 3.2.4 评审记录表 (tbl_review)
```sql
CREATE TABLE tbl_review (
    id BIGSERIAL PRIMARY KEY,
    student_id BIGINT REFERENCES tbl_student(id),
    scholarship_type_id BIGINT REFERENCES tbl_scholarship_type(id),
    reviewer_id BIGINT REFERENCES tbl_user(id),
    application_status VARCHAR(20) NOT NULL DEFAULT 'pending' 
        CHECK (application_status IN ('draft', 'submitted', 'under_review', 'approved', 'rejected', 'withdrawn')),
    review_status VARCHAR(20) NOT NULL DEFAULT 'pending'
        CHECK (review_status IN ('pending', 'approved', 'rejected')),
    academic_score DECIMAL(5,2),
    conduct_score DECIMAL(5,2),
    extra_score DECIMAL(5,2),
    total_score DECIMAL(5,2),
    review_opinion TEXT,
    reviewer_notes TEXT,
    submitted_at TIMESTAMP,
    reviewed_at TIMESTAMP,
    approved_at TIMESTAMP,
    rejected_reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 0,
    UNIQUE(student_id, scholarship_type_id, academic_year)
);

-- 创建索引
CREATE INDEX idx_review_student ON tbl_review(student_id);
CREATE INDEX idx_review_scholarship ON tbl_review(scholarship_type_id);
CREATE INDEX idx_review_reviewer ON tbl_review(reviewer_id);
CREATE INDEX idx_review_status ON tbl_review(review_status);
CREATE INDEX idx_review_application_status ON tbl_review(application_status);
```

#### 3.2.5 公示表 (tbl_announcement)
```sql
CREATE TABLE tbl_announcement (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    summary VARCHAR(500),
    type VARCHAR(20) NOT NULL DEFAULT 'scholarship'
        CHECK (type IN ('scholarship', 'notice', 'news', 'policy')),
    priority INTEGER DEFAULT 0,
    is_top BOOLEAN DEFAULT false,
    is_public BOOLEAN DEFAULT true,
    is_active BOOLEAN DEFAULT true,
    start_date DATE,
    end_date DATE,
    publish_date DATE DEFAULT CURRENT_DATE,
    view_count INTEGER DEFAULT 0,
    attachments JSONB,
    tags VARCHAR(100)[],
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    published_at TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 0
);

-- 创建索引
CREATE INDEX idx_announcement_type ON tbl_announcement(type);
CREATE INDEX idx_announcement_dates ON tbl_announcement(start_date, end_date);
CREATE INDEX idx_announcement_active ON tbl_announcement(is_active);
CREATE INDEX idx_announcement_top ON tbl_announcement(is_top);
CREATE INDEX idx_announcement_publish_date ON tbl_announcement(publish_date);
```

#### 3.2.6 学业记录表 (tbl_academic_record)
```sql
CREATE TABLE tbl_academic_record (
    id BIGSERIAL PRIMARY KEY,
    student_id BIGINT REFERENCES tbl_student(id),
    academic_year VARCHAR(20) NOT NULL,
    semester VARCHAR(10) NOT NULL,
    course_code VARCHAR(20),
    course_name VARCHAR(100) NOT NULL,
    course_credit DECIMAL(3,1) NOT NULL,
    course_score DECIMAL(5,2),
    course_grade VARCHAR(10),
    gpa DECIMAL(3,2),
    is_retake BOOLEAN DEFAULT false,
    retake_score DECIMAL(5,2),
    teacher_name VARCHAR(50),
    course_category VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    updated_by BIGINT,
    version INTEGER DEFAULT 0
);

-- 创建索引
CREATE INDEX idx_academic_student ON tbl_academic_record(student_id);
CREATE INDEX idx_academic_year_semester ON tbl_academic_record(academic_year, semester);
CREATE INDEX idx_academic_gpa ON tbl_academic_record(gpa);
CREATE INDEX idx_academic_credit ON tbl_academic_record(course_credit);
```

#### 3.2.7 系统配置表 (tbl_system_config)
```sql
CREATE TABLE tbl_system_config (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    config_type VARCHAR(20) DEFAULT 'string'
        CHECK (config_type IN ('string', 'integer', 'boolean', 'json')),
    description TEXT,
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 初始化配置数据
INSERT INTO tbl_system_config (config_key, config_value, config_type, description, is_public) VALUES
('system.name', '高校奖学金管理系统', 'string', '系统名称', true),
('system.version', '1.0.0', 'string', '系统版本', true),
('max.upload.size', '10485760', 'integer', '最大上传文件大小(字节)', false),
('session.timeout', '1800', 'integer', '会话超时时间(秒)', false),
('default.page.size', '20', 'integer', '默认分页大小', false);
```

#### 3.2.8 操作日志表 (tbl_operation_log)
```sql
CREATE TABLE tbl_operation_log (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES tbl_user(id),
    username VARCHAR(50),
    operation VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id VARCHAR(100),
    request_method VARCHAR(10),
    request_url VARCHAR(500),
    request_params JSONB,
    response_status INTEGER,
    response_message TEXT,
    ip_address INET,
    user_agent TEXT,
    execution_time INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_log_user ON tbl_operation_log(user_id);
CREATE INDEX idx_log_operation ON tbl_operation_log(operation);
CREATE INDEX idx_log_resource ON tbl_operation_log(resource_type, resource_id);
CREATE INDEX idx_log_created_at ON tbl_operation_log(created_at);
```

### 3.3 数据库视图设计

#### 3.3.1 学生综合信息视图
```sql
CREATE VIEW v_student_comprehensive AS
SELECT 
    s.id,
    s.student_no,
    s.name,
    s.gender,
    s.college,
    s.major,
    s.class,
    s.grade,
    s.contact,
    u.username,
    u.email,
    u.role,
    u.is_active,
    COUNT(DISTINCT ar.id) as course_count,
    COALESCE(AVG(ar.gpa), 0) as avg_gpa,
    COALESCE(SUM(ar.course_credit), 0) as total_credits,
    COUNT(DISTINCT r.id) as application_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'approved' THEN r.id END) as approved_count
FROM tbl_student s
LEFT JOIN tbl_user u ON s.user_id = u.id
LEFT JOIN tbl_academic_record ar ON s.id = ar.student_id
LEFT JOIN tbl_review r ON s.id = r.student_id
GROUP BY s.id, s.student_no, s.name, s.gender, s.college, s.major, s.class, s.grade, s.contact, 
         u.username, u.email, u.role, u.is_active;
```

#### 3.3.2 奖学金评审汇总视图
```sql
CREATE VIEW v_scholarship_summary AS
SELECT 
    st.id as scholarship_type_id,
    st.name as scholarship_name,
    st.amount,
    st.category,
    COUNT(DISTINCT r.id) as total_applications,
    COUNT(DISTINCT CASE WHEN r.application_status = 'submitted' THEN r.id END) as submitted_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'approved' THEN r.id END) as approved_count,
    COUNT(DISTINCT CASE WHEN r.review_status = 'rejected' THEN r.id END) as rejected_count,
    COALESCE(AVG(r.total_score), 0) as avg_score,
    MIN(r.submitted_at) as first_submission_date,
    MAX(r.reviewed_at) as last_review_date
FROM tbl_scholarship_type st
LEFT JOIN tbl_review r ON st.id = r.scholarship_type_id
GROUP BY st.id, st.name, st.amount, st.category;
```

### 3.4 存储过程设计

#### 3.4.1 计算学生GPA的存储过程
```sql
CREATE OR REPLACE FUNCTION calculate_student_gpa(
    p_student_id BIGINT,
    p_academic_year VARCHAR(20),
    p_semester VARCHAR(10) DEFAULT NULL
)
RETURNS DECIMAL AS $$
DECLARE
    total_credits DECIMAL(10,2) := 0;
    total_quality_points DECIMAL(10,2) := 0;
    calculated_gpa DECIMAL(3,2);
BEGIN
    -- 计算总学分和质量点数
    SELECT 
        COALESCE(SUM(ar.course_credit), 0) as credits,
        COALESCE(SUM(ar.course_credit * ar.gpa), 0) as quality_points
    INTO total_credits, total_quality_points
    FROM tbl_academic_record ar
    WHERE ar.student_id = p_student_id
        AND ar.academic_year = p_academic_year
        AND (p_semester IS NULL OR ar.semester = p_semester)
        AND ar.course_score >= 60; -- 及格成绩才计入GPA
    
    -- 计算GPA
    IF total_credits > 0 THEN
        calculated_gpa := ROUND(total_quality_points / total_credits, 2);
    ELSE
        calculated_gpa := 0;
    END IF;
    
    RETURN calculated_gpa;
END;
$$ LANGUAGE plpgsql;
```

#### 3.4.2 自动生成评审编号的函数
```sql
CREATE OR REPLACE FUNCTION generate_review_number(
    p_scholarship_type_id BIGINT,
    p_academic_year VARCHAR(20)
)
RETURNS VARCHAR(50) AS $$
DECLARE
    scholarship_code VARCHAR(20);
    year_code VARCHAR(10);
    sequence_number INTEGER;
    review_number VARCHAR(50);
BEGIN
    -- 获取奖学金代码
    SELECT code INTO scholarship_code 
    FROM tbl_scholarship_type 
    WHERE id = p_scholarship_type_id;
    
    -- 获取年份代码
    year_code := SUBSTR(p_academic_year, 1, 4);
    
    -- 获取序列号
    SELECT COALESCE(MAX(
        CAST(SUBSTRING(review_no FROM '.*-(\d+)$') AS INTEGER)
    ), 0) + 1
    INTO sequence_number
    FROM tbl_review
    WHERE scholarship_type_id = p_scholarship_type_id
        AND academic_year = p_academic_year;
    
    -- 生成评审编号
    review_number := scholarship_code || '-' || year_code || '-' || LPAD(sequence_number::TEXT, 4, '0');
    
    RETURN review_number;
END;
$$ LANGUAGE plpgsql;
```

## 4. 实体类详细设计

### 4.1 基础实体类

#### 4.1.1 BaseEntity - 基础实体
```java
@MappedSuperclass
@Data
@NoArgsConstructor
@AllArgsConstructor
public abstract class BaseEntity {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @CreationTimestamp
    @Column(name = "created_at", updatable = false)
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by")
    private Long createdBy;
    
    @Column(name = "updated_by")
    private Long updatedBy;
    
    @Version
    private Integer version;
    
    @Transient
    public boolean isNew() {
        return this.id == null;
    }
}
```

#### 4.1.2 User - 用户实体
```java
@Entity
@Table(name = "tbl_user")
@Data
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor
@AllArgsConstructor
public class User extends BaseEntity {
    
    @Column(name = "username", unique = true, nullable = false, length = 50)
    private String username;
    
    @Column(name = "password", nullable = false, length = 255)
    private String password;
    
    @Column(name = "email", unique = true, length = 100)
    private String email;
    
    @Column(name = "phone", length = 20)
    private String phone;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "role", nullable = false, length = 20)
    private UserRole role;
    
    @Column(name = "is_active")
    private Boolean isActive = true;
    
    @Column(name = "last_login_at")
    private LocalDateTime lastLoginAt;
    
    @Column(name = "password_changed_at")
    private LocalDateTime passwordChangedAt;
    
    @OneToOne(mappedBy = "user", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private Student student;
    
    @PrePersist
    protected void onCreate() {
        if (passwordChangedAt == null) {
            passwordChangedAt = LocalDateTime.now();
        }
    }
    
    public enum UserRole {
        ADMIN, STUDENT, TEACHER
    }
}
```

#### 4.1.3 Student - 学生实体
```java
@Entity
@Table(name = "tbl_student")
@Data
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor
@AllArgsConstructor
public class Student extends BaseEntity {
    
    @OneToOne
    @JoinColumn(name = "user_id", foreignKey = @ForeignKey(name = "fk_student_user"))
    private User user;
    
    @Column(name = "student_no", unique = true, nullable = false, length = 20)
    private String studentNo;
    
    @Column(name = "name", nullable = false, length = 50)
    private String name;
    
    @Column(name = "gender", length = 1)
    private String gender; // M/F
    
    @Column(name = "birth_date")
    private LocalDate birthDate;
    
    @Column(name = "id_card", unique = true, length = 18)
    private String idCard;
    
    @Column(name = "college", nullable = false, length = 100)
    private String college;
    
    @Column(name = "major", nullable = false, length = 100)
    private String major;
    
    @Column(name = "class", nullable = false, length = 50)
    private String studentClass;
    
    @Column(name = "grade", length = 10)
    private String grade;
    
    @Column(name = "contact", length = 100)
    private String contact;
    
    @Column(name = "emergency_contact", length = 100)
    private String emergencyContact;
    
    @Column(name = "address", columnDefinition = "TEXT")
    private String address;
    
    @Column(name = "avatar_url", length = 500)
    private String avatarUrl;
    
    @Column(name = "enrollment_date")
    private LocalDate enrollmentDate;
    
    @Column(name = "graduation_date")
    private LocalDate graduationDate;
    
    @Column(name = "is_graduated")
    private Boolean isGraduated = false;
    
    @OneToMany(mappedBy = "student", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<AcademicRecord> academicRecords = new ArrayList<>();
    
    @OneToMany(mappedBy = "student", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<Review> reviews = new ArrayList<>();
    
    @Transient
    public String getFullName() {
        return this.name;
    }
    
    @Transient
    public BigDecimal getCurrentGPA() {
        return academicRecords.stream()
            .map(AcademicRecord::getGpa)
            .filter(Objects::nonNull)
            .reduce(BigDecimal.ZERO, BigDecimal::add)
            .divide(new BigDecimal(academicRecords.size()), 2, RoundingMode.HALF_UP);
    }
}
```

#### 4.1.4 ScholarshipType - 奖学金类型实体
```java
@Entity
@Table(name = "tbl_scholarship_type")
@Data
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor
@AllArgsConstructor
public class ScholarshipType extends BaseEntity {
    
    @Column(name = "name", nullable = false, length = 100)
    private String name;
    
    @Column(name = "code", unique = true, nullable = false, length = 20)
    private String code;
    
    @Column(name = "category", nullable = false, length = 50)
    private String category;
    
    @Column(name = "amount", nullable = false, precision = 10, scale = 2)
    private BigDecimal amount;
    
    @Column(name = "currency", length = 10)
    private String currency = "CNY";
    
    @Column(name = "condition", columnDefinition = "TEXT")
    private String condition;
    
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
    
    @Column(name = "requirements", columnDefinition = "TEXT")
    private String requirements;
    
    @Column(name = "application_start_date")
    private LocalDate applicationStartDate;
    
    @Column(name = "application_end_date")
    private LocalDate applicationEndDate;
    
    @Column(name = "review_start_date")
    private LocalDate reviewStartDate;
    
    @Column(name = "review_end_date")
    private LocalDate reviewEndDate;
    
    @Column(name = "announcement_date")
    private LocalDate announcementDate;
    
    @Column(name = "is_public")
    private Boolean isPublic = true;
    
    @Column(name = "is_active")
    private Boolean isActive = true;
    
    @Column(name = "max_recipients")
    private Integer maxRecipients;
    
    @Column(name = "sort_order")
    private Integer sortOrder = 0;
    
    @OneToMany(mappedBy = "scholarshipType", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private List<Review> reviews = new ArrayList<>();
    
    @Transient
    public boolean isApplicationOpen() {
        if (applicationStartDate == null || applicationEndDate == null) {
            return false;
        }
        LocalDate today = LocalDate.now();
        return !today.isBefore(applicationStartDate) && !today.isAfter(applicationEndDate);
    }
}
```

#### 4.1.5 Review - 评审记录实体
```java
@Entity
@Table(name = "tbl_review")
@Data
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor
@AllArgsConstructor
public class Review extends BaseEntity {
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "student_id", foreignKey = @ForeignKey(name = "fk_review_student"))
    private Student student;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "scholarship_type_id", foreignKey = @ForeignKey(name = "fk_review_scholarship"))
    private ScholarshipType scholarshipType;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "reviewer_id", foreignKey = @ForeignKey(name = "fk_review_reviewer"))
    private User reviewer;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "application_status", nullable = false)
    private ApplicationStatus applicationStatus = ApplicationStatus.DRAFT;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "review_status", nullable = false)
    private ReviewStatus reviewStatus = ReviewStatus.NOT_REVIEWED;
    
    @Column(name = "academic_score", precision = 5, scale = 2)
    private BigDecimal academicScore;
    
    @Column(name = "conduct_score", precision = 5, scale = 2)
    private BigDecimal conductScore;
    
    @Column(name = "extra_score", precision = 5, scale = 2)
    private BigDecimal extraScore;
    
    @Column(name = "total_score", precision = 5, scale = 2)
    private BigDecimal totalScore;
    
    @Column(name = "review_opinion", columnDefinition = "TEXT")
    private String reviewOpinion;
    
    @Column(name = "reviewer_notes", columnDefinition = "TEXT")
    private String reviewerNotes;
    
    @Column(name = "submitted_at")
    private LocalDateTime submittedAt;
    
    @Column(name = "reviewed_at")
    private LocalDateTime reviewedAt;
    
    @Column(name = "approved_at")
    private LocalDateTime approvedAt;
    
    @Column(name = "rejected_reason", columnDefinition = "TEXT")
    private String rejectedReason;
    
    @Column(name = "academic_year", length = 20)
    private String academicYear;
    
    @PrePersist
    protected void onCreate() {
        super.onCreate();
        if (academicYear == null) {
            academicYear = LocalDate.now().getYear() + "-" + (LocalDate.now().getYear() + 1);
        }
    }
    
    @PostPersist
    protected void afterPersist() {
        calculateTotalScore();
    }
    
    @PostUpdate
    protected void afterUpdate() {
        calculateTotalScore();
    }
    
    private void calculateTotalScore() {
        if (academicScore != null || conductScore != null || extraScore != null) {
            BigDecimal academic = academicScore != null ? academicScore : BigDecimal.ZERO;
            BigDecimal conduct = conductScore != null ? conductScore : BigDecimal.ZERO;
            BigDecimal extra = extraScore != null ? extraScore : BigDecimal.ZERO;
            this.totalScore = academic.add(conduct).add(extra);
        }
    }
    
    public enum ApplicationStatus {
        DRAFT, SUBMITTED, UNDER_REVIEW, APPROVED, REJECTED, WITHDRAWN
    }
    
    public enum ReviewStatus {
        NOT_REVIEWED, APPROVED, REJECTED, PENDING
    }
}
```

#### 4.1.6 Announcement - 公示实体
```java
@Entity
@Table(name = "tbl_announcement")
@Data
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor
@AllArgsConstructor
public class Announcement extends BaseEntity {
    
    @Column(name = "title", nullable = false, length = 200)
    private String title;
    
    @Column(name = "content", nullable = false, columnDefinition = "TEXT")
    private String content;
    
    @Column(name = "summary", length = 500)
    private String summary;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "type", nullable = false)
    private AnnouncementType type = AnnouncementType.SCHOLARSHIP;
    
    @Column(name = "priority")
    private Integer priority = 0;
    
    @Column(name = "is_top")
    private Boolean isTop = false;
    
    @Column(name = "is_public")
    private Boolean isPublic = true;
    
    @Column(name = "is_active")
    private Boolean isActive = true;
    
    @Column(name = "start_date")
    private LocalDate startDate;
    
    @Column(name = "end_date")
    private LocalDate endDate;
    
    @Column(name = "publish_date")
    private LocalDate publishDate;
    
    @Column(name = "view_count")
    private Integer viewCount = 0;
    
    @Column(name = "published_at")
    private LocalDateTime publishedAt;
    
    @Column(name = "attachments", columnDefinition = "jsonb")
    private String attachments; // JSON格式的附件信息
    
    @Column(name = "tags", array = true)
    private String[] tags;
    
    @Transient
    public boolean isCurrentlyActive() {
        if (!isActive) return false;
        LocalDate today = LocalDate.now();
        if (startDate != null && today.isBefore(startDate)) return false;
        if (endDate != null && today.isAfter(endDate)) return false;
        return true;
    }
    
    public enum AnnouncementType {
        SCHOLARSHIP, NOTICE, NEWS, POLICY
    }
}
```

#### 4.1.7 AcademicRecord - 学业记录实体
```java
@Entity
@Table(name = "tbl_academic_record")
@Data
@EqualsAndHashCode(callSuper = true)
@NoArgsConstructor
@AllArgsConstructor
public class AcademicRecord extends BaseEntity {
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "student_id", foreignKey = @ForeignKey(name = "fk_academic_student"))
    private Student student;
    
    @Column(name = "academic_year", nullable = false, length = 20)
    private String academicYear;
    
    @Column(name = "semester", nullable = false, length = 10)
    private String semester;
    
    @Column(name = "course_code", length = 20)
    private String courseCode;
    
    @Column(name = "course_name", nullable = false, length = 100)
    private String courseName;
    
    @Column(name = "course_credit", nullable = false, precision = 3, scale = 1)
    private BigDecimal courseCredit;
    
    @Column(name = "course_score", precision = 5, scale = 2)
    private BigDecimal courseScore;
    
    @Column(name = "course_grade", length = 10)
    private String courseGrade;
    
    @Column(name = "gpa", precision = 3, scale = 2)
    private BigDecimal gpa;
    
    @Column(name = "is_retake")
    private Boolean isRetake = false;
    
    @Column(name = "retake_score", precision = 5, scale = 2)
    private BigDecimal retakeScore;
    
    @Column(name = "teacher_name", length = 50)
    private String teacherName;
    
    @Column(name = "course_category", length = 50)
    private String courseCategory;
    
    @Transient
    public boolean isPassed() {
        return courseScore != null && courseScore.compareTo(new BigDecimal("60")) >= 0;
    }
    
    @Transient
    public BigDecimal getEffectiveScore() {
        if (isRetake && retakeScore != null) {
            return retakeScore;
        }
        return courseScore;
    }
}
```

## 5. Repository层详细设计

### 5.1 基础Repository接口

#### 5.1.1 BaseRepository接口
```java
@Repository
public interface BaseRepository<T, ID extends Serializable> extends JpaRepository<T, ID>, JpaSpecificationExecutor<T> {
    
    /**
     * 根据创建人查询
     */
    @Query("SELECT e FROM #{#entityName} e WHERE e.createdBy = :createdBy ORDER BY e.createdAt DESC")
    List<T> findByCreatedBy(@Param("createdBy") Long createdBy);
    
    /**
     * 根据时间范围查询
     */
    @Query("SELECT e FROM #{#entityName} e WHERE e.createdAt BETWEEN :startTime AND :endTime ORDER BY e.createdAt DESC")
    List<T> findByCreatedAtBetween(@Param("startTime") LocalDateTime startTime, 
                                  @Param("endTime") LocalDateTime endTime);
    
    /**
     * 统计记录数量
     */
    @Query("SELECT COUNT(e) FROM #{#entityName} e")
    long countAll();
    
    /**
     * 批量删除（软删除）
     */
    @Modifying
    @Query("UPDATE #{#entityName} e SET e.updatedAt = CURRENT_TIMESTAMP WHERE e.id IN :ids")
    int softDeleteByIdIn(@Param("ids") Collection<ID> ids);
}
```

#### 5.1.2 UserRepository接口
```java
@Repository
public interface UserRepository extends BaseRepository<User, Long> {
    
    /**
     * 根据用户名查找用户
     */
    Optional<User> findByUsername(String username);
    
    /**
     * 根据邮箱查找用户
     */
    Optional<User> findByEmail(String email);
    
    /**
     * 根据角色查找用户
     */
    List<User> findByRole(User.UserRole role);
    
    /**
     * 查找活跃用户
     */
    List<User> findByIsActiveTrue();
    
    /**
     * 根据用户名和角色查找
     */
    Optional<User> findByUsernameAndRole(String username, User.UserRole role);
    
    /**
     * 分页查询用户
     */
    @Query("SELECT u FROM User u WHERE " +
           "(:username IS NULL OR u.username LIKE %:username%) AND " +
           "(:email IS NULL OR u.email LIKE %:email%) AND " +
           "(:role IS NULL OR u.role = :role) AND " +
           "(:isActive IS NULL OR u.isActive = :isActive)")
    Page<User> findUsers(@Param("username") String username,
                        @Param("email") String email,
                        @Param("role") User.UserRole role,
                        @Param("isActive") Boolean isActive,
                        Pageable pageable);
    
    /**
     * 检查用户名是否存在
     */
    @Query("SELECT COUNT(u) > 0 FROM User u WHERE u.username = :username")
    boolean existsByUsername(@Param("username") String username);
    
    /**
     * 检查邮箱是否存在
     */
    @Query("SELECT COUNT(u) > 0 FROM User u WHERE u.email = :email")
    boolean existsByEmail(@Param("email") String email);
    
    /**
     * 更新最后登录时间
     */
    @Modifying
    @Query("UPDATE User u SET u.lastLoginAt = :lastLoginAt WHERE u.id = :id")
    void updateLastLoginAt(@Param("id") Long id, @Param("lastLoginAt") LocalDateTime lastLoginAt);
}
```

#### 5.1.3 StudentRepository接口
```java
@Repository
public interface StudentRepository extends BaseRepository<Student, Long> {
    
    /**
     * 根据学号查找学生
     */
    Optional<Student> findByStudentNo(String studentNo);
    
    /**
     * 根据学院和专业查找学生
     */
    List<Student> findByCollegeAndMajor(String college, String major);
    
    /**
     * 根据班级查找学生
     */
    List<Student> findByStudentClass(String studentClass);
    
    /**
     * 根据年级查找学生
     */
    List<Student> findByGrade(String grade);
    
    /**
     * 根据用户ID查找学生
     */
    Optional<Student> findByUserId(Long userId);
    
    /**
     * 查找未毕业学生
     */
    List<Student> findByIsGraduatedFalse();
    
    /**
     * 分页查询学生
     */
    @Query("SELECT s FROM Student s WHERE " +
           "(:studentNo IS NULL OR s.studentNo LIKE %:studentNo%) AND " +
           "(:name IS NULL OR s.name LIKE %:name%) AND " +
           "(:college IS NULL OR s.college LIKE %:college%) AND " +
           "(:major IS NULL OR s.major LIKE %:major%) AND " +
           "(:studentClass IS NULL OR s.studentClass LIKE %:studentClass%) AND " +
           "(:grade IS NULL OR s.grade = :grade)")
    Page<Student> findStudents(@Param("studentNo") String studentNo,
                              @Param("name") String name,
                              @Param("college") String college,
                              @Param("major") String major,
                              @Param("studentClass") String studentClass,
                              @Param("grade") String grade,
                              Pageable pageable);
    
    /**
     * 统计各学院学生数量
     */
    @Query("SELECT s.college, COUNT(s) FROM Student s GROUP BY s.college")
    List<Object[]> countStudentsByCollege();
    
    /**
     * 统计各专业学生数量
     */
    @Query("SELECT s.major, COUNT(s) FROM Student s GROUP BY s.major")
    List<Object[]> countStudentsByMajor();
    
    /**
     * 查找有申请记录的学生
     */
    @Query("SELECT DISTINCT s FROM Student s JOIN s.reviews r")
    List<Student> findStudentsWithApplications();
    
    /**
     * 根据GPA范围查找学生
     */
    @Query("SELECT s FROM Student s JOIN s.academicRecords ar WHERE ar.gpa BETWEEN :minGpa AND :maxGpa")
    List<Student> findByGpaBetween(@Param("minGpa") BigDecimal minGpa, @Param("maxGpa") BigDecimal maxGpa);
}
```

#### 5.1.4 ScholarshipTypeRepository接口
```java
@Repository
public interface ScholarshipTypeRepository extends BaseRepository<ScholarshipType, Long> {
    
    /**
     * 根据代码查找奖学金类型
     */
    Optional<ScholarshipType> findByCode(String code);
    
    /**
     * 根据类别查找奖学金类型
     */
    List<ScholarshipType> findByCategory(String category);
    
    /**
     * 查找活跃的奖学金类型
     */
    List<ScholarshipType> findByIsActiveTrue();
    
    /**
     * 查找公开的奖学金类型
     */
    List<ScholarshipType> findByIsPublicTrueAndIsActiveTrue();
    
    /**
     * 查找当前可申请的奖学金
     */
    @Query("SELECT st FROM ScholarshipType st WHERE st.isActive = true AND " +
           "st.applicationStartDate <= CURRENT_DATE AND st.applicationEndDate >= CURRENT_DATE")
    List<ScholarshipType> findAvailableScholarships();
    
    /**
     * 分页查询奖学金类型
     */
    @Query("SELECT st FROM ScholarshipType st WHERE " +
           "(:name IS NULL OR st.name LIKE %:name%) AND " +
           "(:category IS NULL OR st.category LIKE %:category%) AND " +
           "(:isActive IS NULL OR st.isActive = :isActive)")
    Page<ScholarshipType> findScholarshipTypes(@Param("name") String name,
                                              @Param("category") String category,
                                              @Param("isActive") Boolean isActive,
                                              Pageable pageable);
    
    /**
     * 统计各类别奖学金数量
     */
    @Query("SELECT st.category, COUNT(st) FROM ScholarshipType st GROUP BY st.category")
    List<Object[]> countScholarshipTypesByCategory();
    
    /**
     * 按申请时间排序的奖学金
     */
    @Query("SELECT st FROM ScholarshipType st WHERE st.isActive = true ORDER BY st.applicationStartDate DESC")
    List<ScholarshipType> findOrderByApplicationStartDate();
}
```

#### 5.1.5 ReviewRepository接口
```java
@Repository
public interface ReviewRepository extends BaseRepository<Review, Long> {
    
    /**
     * 根据学生和奖学金类型查找评审记录
     */
    Optional<Review> findByStudentIdAndScholarshipTypeId(Long studentId, Long scholarshipTypeId);
    
    /**
     * 根据学生查找评审记录
     */
    List<Review> findByStudentId(Long studentId);
    
    /**
     * 根据奖学金类型查找评审记录
     */
    List<Review> findByScholarshipTypeId(Long scholarshipTypeId);
    
    /**
     * 根据评审人查找评审记录
     */
    List<Review> findByReviewerId(Long reviewerId);
    
    /**
     * 根据申请状态查找评审记录
     */
    List<Review> findByApplicationStatus(Review.ApplicationStatus applicationStatus);
    
    /**
     * 根据评审状态查找评审记录
     */
    List<Review> findByReviewStatus(Review.ReviewStatus reviewStatus);
    
    /**
     * 查找已提交的评审记录
     */
    @Query("SELECT r FROM Review r WHERE r.applicationStatus = 'SUBMITTED' ORDER BY r.submittedAt DESC")
    List<Review> findSubmittedReviews();
    
    /**
     * 查找待审核的评审记录
     */
    @Query("SELECT r FROM Review r WHERE r.applicationStatus = 'UNDER_REVIEW' AND r.reviewStatus = 'PENDING' ORDER BY r.submittedAt")
    List<Review> findPendingReviews();
    
    /**
     * 分页查询评审记录
     */
    @Query("SELECT r FROM Review r WHERE " +
           "(:studentName IS NULL OR r.student.name LIKE %:studentName%) AND " +
           "(:scholarshipName IS NULL OR r.scholarshipType.name LIKE %:scholarshipName%) AND " +
           "(:applicationStatus IS NULL OR r.applicationStatus = :applicationStatus) AND " +
           "(:reviewStatus IS NULL OR r.reviewStatus = :reviewStatus)")
    Page<Review> findReviews(@Param("studentName") String studentName,
                            @Param("scholarshipName") String scholarshipName,
                            @Param("applicationStatus") Review.ApplicationStatus applicationStatus,
                            @Param("reviewStatus") Review.ReviewStatus reviewStatus,
                            Pageable pageable);
    
    /**
     * 统计各状态评审数量
     */
    @Query("SELECT r.applicationStatus, COUNT(r) FROM Review r GROUP BY r.applicationStatus")
    List<Object[]> countReviewsByApplicationStatus();
    
    /**
     * 统计各奖学金申请数量
     */
    @Query("SELECT r.scholarshipType.name, COUNT(r) FROM Review r GROUP BY r.scholarshipType.name")
    List<Object[]> countReviewsByScholarshipType();
    
    /**
     * 计算平均分数
     */
    @Query("SELECT AVG(r.totalScore) FROM Review r WHERE r.reviewStatus = 'APPROVED' AND r.scholarshipType.id = :scholarshipTypeId")
    BigDecimal calculateAverageScoreByScholarshipTypeId(@Param("scholarshipTypeId") Long scholarshipTypeId);
    
    /**
     * 查找学生的申请历史
     */
    @Query("SELECT r FROM Review r WHERE r.student.id = :studentId ORDER BY r.createdAt DESC")
    List<Review> findStudentApplicationHistory(@Param("studentId") Long studentId);
}
```

#### 5.1.6 AnnouncementRepository接口
```java
@Repository
public interface AnnouncementRepository extends BaseRepository<Announcement, Long> {
    
    /**
     * 根据类型查找公示
     */
    List<Announcement> findByType(Announcement.AnnouncementType type);
    
    /**
     * 查找激活的公示
     */
    @Query("SELECT a FROM Announcement a WHERE a.isActive = true ORDER BY a.isTop DESC, a.publishDate DESC")
    List<Announcement> findActiveAnnouncements();
    
    /**
     * 查找公开的公示
     */
    @Query("SELECT a FROM Announcement a WHERE a.isPublic = true AND a.isActive = true")
    List<Announcement> findPublicAnnouncements();
    
    /**
     * 查找当前有效的公示
     */
    @Query("SELECT a FROM Announcement a WHERE a.isActive = true AND " +
           "(a.startDate IS NULL OR a.startDate <= CURRENT_DATE) AND " +
           "(a.endDate IS NULL OR a.endDate >= CURRENT_DATE) ORDER BY a.isTop DESC, a.priority DESC, a.publishDate DESC")
    List<Announcement> findCurrentlyActiveAnnouncements();
    
    /**
     * 置顶公示
     */
    @Query("SELECT a FROM Announcement a WHERE a.isTop = true AND a.isActive = true ORDER BY a.priority DESC, a.publishDate DESC")
    List<Announcement> findTopAnnouncements();
    
    /**
     * 分页查询公示
     */
    @Query("SELECT a FROM Announcement a WHERE " +
           "(:title IS NULL OR a.title LIKE %:title%) AND " +
           "(:type IS NULL OR a.type = :type) AND " +
           "(:isActive IS NULL OR a.isActive = :isActive) AND " +
           "(:isPublic IS NULL OR a.isPublic = :isPublic)")
    Page<Announcement> findAnnouncements(@Param("title") String title,
                                        @Param("type") Announcement.AnnouncementType type,
                                        @Param("isActive") Boolean isActive,
                                        @Param("isPublic") Boolean isPublic,
                                        Pageable pageable);
    
    /**
     * 按时间范围查询公示
     */
    @Query("SELECT a FROM Announcement a WHERE a.publishDate BETWEEN :startDate AND :endDate ORDER BY a.publishDate DESC")
    List<Announcement> findByPublishDateBetween(@Param("startDate") LocalDate startDate,
                                               @Param("endDate") LocalDate endDate);
    
    /**
     * 增加查看次数
     */
    @Modifying
    @Query("UPDATE Announcement a SET a.viewCount = a.viewCount + 1 WHERE a.id = :id")
    void incrementViewCount(@Param("id") Long id);
    
    /**
     * 统计各类公示数量
     */
    @Query("SELECT a.type, COUNT(a) FROM Announcement a GROUP BY a.type")
    List<Object[]> countAnnouncementsByType();
}
```

#### 5.1.7 AcademicRecordRepository接口
```java
@Repository
public interface AcademicRecordRepository extends BaseRepository<AcademicRecord, Long> {
    
    /**
     * 根据学生查找学业记录
     */
    List<AcademicRecord> findByStudentId(Long studentId);
    
    /**
     * 根据学年查找学业记录
     */
    List<AcademicRecord> findByAcademicYear(String academicYear);
    
    /**
     * 根据学年和学期查找学业记录
     */
    List<AcademicRecord> findByAcademicYearAndSemester(String academicYear, String semester);
    
    /**
     * 查找学生的最新学业记录
     */
    @Query("SELECT ar FROM AcademicRecord ar WHERE ar.student.id = :studentId ORDER BY ar.academicYear DESC, ar.semester DESC")
    List<AcademicRecord> findLatestRecordsByStudentId(@Param("studentId") Long studentId);
    
    /**
     * 计算学生的平均GPA
     */
    @Query("SELECT AVG(ar.gpa) FROM AcademicRecord ar WHERE ar.student.id = :studentId")
    BigDecimal calculateAverageGpaByStudentId(@Param("studentId") Long studentId);
    
    /**
     * 计算学生指定学年的GPA
     */
    @Query("SELECT AVG(ar.gpa) FROM AcademicRecord ar WHERE ar.student.id = :studentId AND ar.academicYear = :academicYear")
    BigDecimal calculateGpaByStudentAndYear(@Param("studentId") Long studentId, @Param("academicYear") String academicYear);
    
    /**
     * 分页查询学业记录
     */
    @Query("SELECT ar FROM AcademicRecord ar WHERE " +
           "(:studentName IS NULL OR ar.student.name LIKE %:studentName%) AND " +
           "(:courseName IS NULL OR ar.courseName LIKE %:courseName%) AND " +
           "(:academicYear IS NULL OR ar.academicYear = :academicYear) AND " +
           "(:semester IS NULL OR ar.semester = :semester)")
    Page<AcademicRecord> findAcademicRecords(@Param("studentName") String studentName,
                                            @Param("courseName") String courseName,
                                            @Param("academicYear") String academicYear,
                                            @Param("semester") String semester,
                                            Pageable pageable);
    
    /**
     * 统计各学期课程数量
     */
    @Query("SELECT ar.academicYear, ar.semester, COUNT(ar) FROM AcademicRecord ar GROUP BY ar.academicYear, ar.semester")
    List<Object[]> countCoursesByYearAndSemester();
    
    /**
     * 查找高分课程（成绩>=90）
     */
    @Query("SELECT ar FROM AcademicRecord ar WHERE ar.courseScore >= 90 ORDER BY ar.courseScore DESC")
    List<AcademicRecord> findHighScoreRecords();
    
    /**
     * 统计各分数段课程数量
     */
    @Query("SELECT " +
           "CASE " +
           "WHEN ar.courseScore >= 90 THEN '优秀(90-100)' " +
           "WHEN ar.courseScore >= 80 THEN '良好(80-89)' " +
           "WHEN ar.courseScore >= 70 THEN '中等(70-79)' " +
           "WHEN ar.courseScore >= 60 THEN '及格(60-69)' " +
           "ELSE '不及格(<60)' " +
           "END as scoreRange, " +
           "COUNT(ar) as count " +
           "FROM AcademicRecord ar GROUP BY " +
           "CASE " +
           "WHEN ar.courseScore >= 90 THEN '优秀(90-100)' " +
           "WHEN ar.courseScore >= 80 THEN '良好(80-89)' " +
           "WHEN ar.courseScore >= 70 THEN '中等(70-79)' " +
           "WHEN ar.courseScore >= 60 THEN '及格(60-69)' " +
           "ELSE '不及格(<60)' " +
           "END")
    List<Object[]> countCoursesByScoreRange();
}
```

## 6. Service层详细设计

### 6.1 基础Service接口

#### 6.1.1 BaseService接口
```java
@Service
public interface BaseService<T, ID extends Serializable> {
    
    /**
     * 保存实体
     */
    T save(T entity);
    
    /**
     * 保存所有实体
     */
    List<T> saveAll(Iterable<T> entities);
    
    /**
     * 根据ID查找
     */
    Optional<T> findById(ID id);
    
    /**
     * 查找所有
     */
    List<T> findAll();
    
    /**
     * 分页查询
     */
    Page<T> findAll(Pageable pageable);
    
    /**
     * 统计数量
     */
    long count();
    
    /**
     * 删除实体
     */
    void delete(T entity);
    
    /**
     * 根据ID删除
     */
    void deleteById(ID id);
    
    /**
     * 批量删除
     */
    void deleteAllById(Iterable<ID> ids);
    
    /**
     * 判断是否存在
     */
    boolean existsById(ID id);
}
```

#### 6.1.2 UserService接口和实现
```java
public interface UserService extends BaseService<User, Long> {
    
    /**
     * 根据用户名查找用户
     */
    Optional<User> findByUsername(String username);
    
    /**
     * 用户登录
     */
    User login(String username, String password);
    
    /**
     * 用户注册
     */
    User register(User user, String rawPassword);
    
    /**
     * 修改密码
     */
    void changePassword(Long userId, String oldPassword, String newPassword);
    
    /**
     * 重置密码
     */
    void resetPassword(Long userId, String newPassword);
    
    /**
     * 更新用户信息
     */
    User updateProfile(Long userId, User user);
    
    /**
     * 锁定/解锁用户
     */
    void toggleUserStatus(Long userId, Boolean isActive);
    
    /**
     * 分页查询用户
     */
    Page<User> findUsers(String username, String email, User.UserRole role, 
                        Boolean isActive, Pageable pageable);
    
    /**
     * 获取用户权限列表
     */
    List<String> getUserPermissions(Long userId);
    
    /**
     * 检查用户名是否存在
     */
    boolean existsByUsername(String username);
    
    /**
     * 检查邮箱是否存在
     */
    boolean existsByEmail(String email);
    
    /**
     * 更新最后登录时间
     */
    void updateLastLoginTime(Long userId);
}

@Service
@Transactional
@Slf4j
public class UserServiceImpl implements UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Autowired
    private PermissionService permissionService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public User save(User user) {
        log.info("保存用户信息: {}", user.getUsername());
        return userRepository.save(user);
    }
    
    @Override
    public List<User> saveAll(Iterable<User> entities) {
        return userRepository.saveAll(entities);
    }
    
    @Override
    public Optional<User> findById(Long id) {
        return userRepository.findById(id);
    }
    
    @Override
    public Optional<User> findByUsername(String username) {
        return userRepository.findByUsername(username);
    }
    
    @Override
    @Transactional(readOnly = true)
    public User login(String username, String password) {
        log.info("用户登录: {}", username);
        
        Optional<User> userOptional = userRepository.findByUsername(username);
        if (userOptional.isPresent()) {
            User user = userOptional.get();
            
            // 检查用户状态
            if (!user.getIsActive()) {
                throw new BusinessException("用户已被禁用，请联系管理员");
            }
            
            // 验证密码
            if (passwordEncoder.matches(password, user.getPassword())) {
                // 更新最后登录时间
                updateLastLoginTime(user.getId());
                
                // 清除登录失败次数缓存
                String failKey = "login:fail:" + username;
                redisTemplate.delete(failKey);
                
                log.info("用户登录成功: {}", username);
                return user;
            } else {
                // 记录登录失败次数
                String failKey = "login:fail:" + username;
                Long failCount = redisTemplate.opsForValue().increment(failKey);
                redisTemplate.expire(failKey, Duration.ofHours(1));
                
                // 如果失败次数过多，临时锁定账户
                if (failCount >= 5) {
                    user.setIsActive(false);
                    userRepository.save(user);
                    throw new BusinessException("登录失败次数过多，账户已被临时锁定，请联系管理员");
                }
                
                throw new BusinessException("用户名或密码错误");
            }
        }
        
        throw new BusinessException("用户不存在");
    }
    
    @Override
    public User register(User user, String rawPassword) {
        log.info("用户注册: {}", user.getUsername());
        
        // 检查用户名是否存在
        if (existsByUsername(user.getUsername())) {
            throw new BusinessException("用户名已存在");
        }
        
        // 检查邮箱是否存在
        if (user.getEmail() != null && existsByEmail(user.getEmail())) {
            throw new BusinessException("邮箱已存在");
        }
        
        // 加密密码
        user.setPassword(passwordEncoder.encode(rawPassword));
        user.setPasswordChangedAt(LocalDateTime.now());
        
        // 设置默认状态
        if (user.getIsActive() == null) {
            user.setIsActive(true);
        }
        
        User savedUser = userRepository.save(user);
        log.info("用户注册成功: {}", savedUser.getUsername());
        
        return savedUser;
    }
    
    @Override
    public void changePassword(Long userId, String oldPassword, String newPassword) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException("用户不存在"));
        
        // 验证旧密码
        if (!passwordEncoder.matches(oldPassword, user.getPassword())) {
            throw new BusinessException("原密码错误");
        }
        
        // 设置新密码
        user.setPassword(passwordEncoder.encode(newPassword));
        user.setPasswordChangedAt(LocalDateTime.now());
        userRepository.save(user);
        
        log.info("用户修改密码成功: {}", user.getUsername());
    }
    
    @Override
    public void resetPassword(Long userId, String newPassword) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException("用户不存在"));
        
        user.setPassword(passwordEncoder.encode(newPassword));
        user.setPasswordChangedAt(LocalDateTime.now());
        userRepository.save(user);
        
        log.info("管理员重置用户密码: {}", user.getUsername());
    }
    
    @Override
    public User updateProfile(Long userId, User user) {
        User existingUser = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException("用户不存在"));
        
        // 更新允许修改的字段
        if (user.getEmail() != null && !user.getEmail().equals(existingUser.getEmail())) {
            // 检查新邮箱是否已被使用
            if (existsByEmail(user.getEmail())) {
                throw new BusinessException("邮箱已被使用");
            }
            existingUser.setEmail(user.getEmail());
        }
        
        if (user.getPhone() != null) {
            existingUser.setPhone(user.getPhone());
        }
        
        return userRepository.save(existingUser);
    }
    
    @Override
    public void toggleUserStatus(Long userId, Boolean isActive) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new BusinessException("用户不存在"));
        
        user.setIsActive(isActive);
        userRepository.save(user);
        
        log.info("{}用户状态: {}", isActive ? "启用" : "禁用", user.getUsername());
    }
    
    @Override
    @Transactional(readOnly = true)
    public Page<User> findUsers(String username, String email, User.UserRole role, 
                               Boolean isActive, Pageable pageable) {
        return userRepository.findUsers(username, email, role, isActive, pageable);
    }
    
    @Override
    @Transactional(readOnly = true)
    public List<String> getUserPermissions(Long userId) {
        // 从缓存获取权限
        String cacheKey = "user:permissions:" + userId;
        List<String> permissions = (List<String>) redisTemplate.opsForValue().get(cacheKey);
        
        if (permissions == null) {
            // 从数据库获取权限
            permissions = permissionService.getPermissionsByUserId(userId);
            
            // 缓存权限信息
            redisTemplate.opsForValue().set(cacheKey, permissions, Duration.ofHours(1));
        }
        
        return permissions;
    }
    
    @Override
    public boolean existsByUsername(String username) {
        return userRepository.existsByUsername(username);
    }
    
    @Override
    public boolean existsByEmail(String email) {
        return userRepository.existsByEmail(email);
    }
    
    @Override
    public void updateLastLoginTime(Long userId) {
        userRepository.updateLastLoginAt(userId, LocalDateTime.now());
    }
    
    // 其他BaseService方法的实现...
    
    @Override
    public List<User> findAll() {
        return userRepository.findAll();
    }
    
    @Override
    public Page<User> findAll(Pageable pageable) {
        return userRepository.findAll(pageable);
    }
    
    @Override
    public long count() {
        return userRepository.countAll();
    }
    
    @Override
    public void delete(User entity) {
        userRepository.delete(entity);
    }
    
    @Override
    public void deleteById(Long id) {
        userRepository.deleteById(id);
    }
    
    @Override
    public void deleteAllById(Iterable<? extends Long> ids) {
        userRepository.softDeleteByIdIn(ids);
    }
    
    @Override
    public boolean existsById(Long id) {
        return userRepository.existsById(id);
    }
}
```

#### 6.1.3 StudentService接口和实现
```java
public interface StudentService extends BaseService<Student, Long> {
    
    /**
     * 根据学号查找学生
     */
    Optional<Student> findByStudentNo(String studentNo);
    
    /**
     * 根据用户ID查找学生
     */
    Optional<Student> findByUserId(Long userId);
    
    /**
     * 创建学生档案
     */
    Student createStudentProfile(User user, Student student);
    
    /**
     * 更新学生信息
     */
    Student updateStudentInfo(Long studentId, Student student);
    
    /**
     * 获取学生完整信息（包括学业记录等）
     */
    Student getStudentCompleteInfo(Long studentId);
    
    /**
     * 计算学生GPA
     */
    BigDecimal calculateStudentGPA(Long studentId, String academicYear);
    
    /**
     * 分页查询学生
     */
    Page<Student> findStudents(String studentNo, String name, String college, 
                              String major, String studentClass, String grade, 
                              Pageable pageable);
    
    /**
     * 统计各学院学生数量
     */
    Map<String, Long> getCollegeStatistics();
    
    /**
     * 统计各专业学生数量
     */
    Map<String, Long> getMajorStatistics();
    
    /**
     * 导入学生信息
     */
    List<Student> importStudents(List<Student> students);
    
    /**
     * 导出学生信息
     */
    List<Student> exportStudents(String college, String major, String grade);
}

@Service
@Transactional
@Slf4j
public class StudentServiceImpl implements StudentService {
    
    @Autowired
    private StudentRepository studentRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private AcademicRecordService academicRecordService;
    
    @Autowired
    private UserService userService;
    
    @Override
    public Student save(Student student) {
        log.info("保存学生信息: {}", student.getStudentNo());
        return studentRepository.save(student);
    }
    
    @Override
    public Optional<Student> findByStudentNo(String studentNo) {
        return studentRepository.findByStudentNo(studentNo);
    }
    
    @Override
    public Optional<Student> findByUserId(Long userId) {
        return studentRepository.findByUserId(userId);
    }
    
    @Override
    @Transactional
    public Student createStudentProfile(User user, Student student) {
        log.info("创建学生档案: {}", student.getStudentNo());
        
        // 检查学号是否已存在
        if (findByStudentNo(student.getStudentNo()).isPresent()) {
            throw new BusinessException("学号已存在");
        }
        
        // 关联用户
        student.setUser(user);
        
        // 设置默认值
        if (student.getEnrollmentDate() == null) {
            student.setEnrollmentDate(LocalDate.now());
        }
        
        if (student.getIsGraduated() == null) {
            student.setIsGraduated(false);
        }
        
        Student savedStudent = studentRepository.save(student);
        log.info("学生档案创建成功: {}", savedStudent.getStudentNo());
        
        return savedStudent;
    }
    
    @Override
    @Transactional
    public Student updateStudentInfo(Long studentId, Student updatedStudent) {
        Student existingStudent = studentRepository.findById(studentId)
                .orElseThrow(() -> new BusinessException("学生不存在"));
        
        // 检查学号是否冲突
        if (!existingStudent.getStudentNo().equals(updatedStudent.getStudentNo()) &&
            findByStudentNo(updatedStudent.getStudentNo()).isPresent()) {
            throw new BusinessException("学号已存在");
        }
        
        // 更新允许修改的字段
        existingStudent.setName(updatedStudent.getName());
        existingStudent.setGender(updatedStudent.getGender());
        existingStudent.setBirthDate(updatedStudent.getBirthDate());
        existingStudent.setCollege(updatedStudent.getCollege());
        existingStudent.setMajor(updatedStudent.getMajor());
        existingStudent.setStudentClass(updatedStudent.getStudentClass());
        existingStudent.setGrade(updatedStudent.getGrade());
        existingStudent.setContact(updatedStudent.getContact());
        existingStudent.setEmergencyContact(updatedStudent.getEmergencyContact());
        existingStudent.setAddress(updatedStudent.getAddress());
        existingStudent.setAvatarUrl(updatedStudent.getAvatarUrl());
        
        Student savedStudent = studentRepository.save(existingStudent);
        log.info("学生信息更新成功: {}", savedStudent.getStudentNo());
        
        return savedStudent;
    }
    
    @Override
    @Transactional(readOnly = true)
    public Student getStudentCompleteInfo(Long studentId) {
        Student student = studentRepository.findById(studentId)
                .orElseThrow(() -> new BusinessException("学生不存在"));
        
        // 初始化懒加载的关联对象
        Hibernate.initialize(student.getUser());
        Hibernate.initialize(student.getAcademicRecords());
        Hibernate.initialize(student.getReviews());
        
        return student;
    }
    
    @Override
    @Transactional(readOnly = true)
    public BigDecimal calculateStudentGPA(Long studentId, String academicYear) {
        return academicRecordService.calculateGpaByStudentAndYear(studentId, academicYear);
    }
    
    @Override
    @Transactional(readOnly = true)
    public Page<Student> findStudents(String studentNo, String name, String college, 
                                     String major, String studentClass, String grade, 
                                     Pageable pageable) {
        return studentRepository.findStudents(studentNo, name, college, major, studentClass, grade, pageable);
    }
    
    @Override
    @Transactional(readOnly = true)
    public Map<String, Long> getCollegeStatistics() {
        List<Object[]> results = studentRepository.countStudentsByCollege();
        return results.stream()
                .collect(Collectors.toMap(
                    result -> (String) result[0],
                    result -> (Long) result[1]
                ));
    }
    
    @Override
    @Transactional(readOnly = true)
    public Map<String, Long> getMajorStatistics() {
        List<Object[]> results = studentRepository.countStudentsByMajor();
        return results.stream()
                .collect(Collectors.toMap(
                    result -> (String) result[0],
                    result -> (Long) result[1]
                ));
    }
    
    @Override
    @Transactional
    public List<Student> importStudents(List<Student> students) {
        log.info("导入学生信息，数量: {}", students.size());
        
        List<Student> importedStudents = new ArrayList<>();
        
        for (Student student : students) {
            try {
                // 检查学号是否已存在
                if (findByStudentNo(student.getStudentNo()).isPresent()) {
                    log.warn("学号已存在，跳过: {}", student.getStudentNo());
                    continue;
                }
                
                // 设置默认值
                if (student.getEnrollmentDate() == null) {
                    student.setEnrollmentDate(LocalDate.now());
                }
                if (student.getIsGraduated() == null) {
                    student.setIsGraduated(false);
                }
                
                Student savedStudent = studentRepository.save(student);
                importedStudents.add(savedStudent);
                
            } catch (Exception e) {
                log.error("导入学生信息失败: {}", student.getStudentNo(), e);
            }
        }
        
        log.info("成功导入学生信息，数量: {}", importedStudents.size());
        return importedStudents;
    }
    
    @Override
    @Transactional(readOnly = true)
    public List<Student> exportStudents(String college, String major, String grade) {
        Specification<Student> spec = Specification.where(null);
        
        if (college != null) {
            spec = spec.and((root, query, cb) -> 
                cb.equal(root.get("college"), college));
        }
        
        if (major != null) {
            spec = spec.and((root, query, cb) -> 
                cb.equal(root.get("major"), major));
        }
        
        if (grade != null) {
            spec = spec.and((root, query, cb) -> 
                cb.equal(root.get("grade"), grade));
        }
        
        return studentRepository.findAll(spec);
    }
    
    // 其他BaseService方法的实现...
    @Override
    public List<Student> findAll() {
        return studentRepository.findAll();
    }
    
    @Override
    public Page<Student> findAll(Pageable pageable) {
        return studentRepository.findAll(pageable);
    }
    
    @Override
    public long count() {
        return studentRepository.count();
    }
    
    @Override
    public void delete(Student entity) {
        studentRepository.delete(entity);
    }
    
    @Override
    public void deleteById(Long id) {
        studentRepository.deleteById(id);
    }
    
    @Override
    public void deleteAllById(Iterable<? extends Long> ids) {
        studentRepository.softDeleteByIdIn(ids);
    }
    
    @Override
    public boolean existsById(Long id) {
        return studentRepository.existsById(id);
    }
}
```

## 7. Controller层详细设计

### 7.1 基础Controller

#### 7.1.1 BaseController
```java
@Slf4j
@RestController
@RequestMapping("/api")
public abstract class BaseController<T, ID extends Serializable> {
    
    @Autowired
    protected BaseService<T, ID> baseService;
    
    /**
     * 分页查询
     */
    @GetMapping
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Page<T>> findAll(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(defaultValue = "id") String sortBy,
            @RequestParam(defaultValue = "desc") String sortDir) {
        
        Sort sort = Sort.by(Sort.Direction.fromString(sortDir), sortBy);
        Pageable pageable = PageRequest.of(page, size, sort);
        Page<T> result = baseService.findAll(pageable);
        
        return ResponseEntity.ok(result);
    }
    
    /**
     * 根据ID查找
     */
    @GetMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or #id == authentication.principal.id")
    public ResponseEntity<T> findById(@PathVariable ID id) {
        Optional<T> result = baseService.findById(id);
        return result.map(ResponseEntity::ok)
                    .orElse(ResponseEntity.notFound().build());
    }
    
    /**
     * 保存实体
     */
    @PostMapping
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<T> save(@RequestBody T entity) {
        T saved = baseService.save(entity);
        return ResponseEntity.ok(saved);
    }
    
    /**
     * 更新实体
     */
    @PutMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or #id == authentication.principal.id")
    public ResponseEntity<T> update(@PathVariable ID id, @RequestBody T entity) {
        // 验证ID匹配
        try {
            Method setIdMethod = entity.getClass().getMethod("setId", id.getClass());
            setIdMethod.invoke(entity, id);
        } catch (Exception e) {
            log.error("设置ID失败", e);
        }
        
        T updated = baseService.save(entity);
        return ResponseEntity.ok(updated);
    }
    
    /**
     * 删除实体
     */
    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Void> deleteById(@PathVariable ID id) {
        baseService.deleteById(id);
        return ResponseEntity.ok().build();
    }
    
    /**
     * 批量删除
     */
    @DeleteMapping("/batch")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Void> deleteByIds(@RequestParam List<ID> ids) {
        baseService.deleteAllById(ids);
        return ResponseEntity.ok().build();
    }
    
    /**
     * 统计数量
     */
    @GetMapping("/count")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<Long> count() {
        long count = baseService.count();
        return ResponseEntity.ok(count);
    }
    
    /**
     * 检查是否存在
     */
    @GetMapping("/exists/{id}")
    @PreAuthorize("hasRole('ADMIN') or #id == authentication.principal.id")
    public ResponseEntity<Boolean> existsById(@PathVariable ID id) {
        boolean exists = baseService.existsById(id);
        return ResponseEntity.ok(exists);
    }
}
```

### 7.2 专门的Controller设计

#### 7.2.1 AuthController - 认证控制器
```java
@RestController
@RequestMapping("/api/auth")
@CrossOrigin(origins = "*", maxAge = 3600)
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private JwtTokenProvider tokenProvider;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * 用户登录
     */
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest loginRequest) {
        try {
            // 验证用户
            User user = userService.login(loginRequest.getUsername(), loginRequest.getPassword());
            
            // 认证用户
            Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                    loginRequest.getUsername(),
                    loginRequest.getPassword()
                )
            );
            
            // 生成JWT Token
            String jwt = tokenProvider.generateToken(authentication);
            
            // 构建响应
            AuthResponse authResponse = AuthResponse.builder()
                .token(jwt)
                .tokenType("Bearer")
                .expiresIn(tokenProvider.getExpirationTime())
                .user(UserDto.fromUser(user))
                .build();
            
            log.info("用户登录成功: {}", loginRequest.getUsername());
            return ResponseEntity.ok(authResponse);
            
        } catch (Exception e) {
            log.error("用户登录失败: {}", loginRequest.getUsername(), e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "登录失败: " + e.getMessage()));
        }
    }
    
    /**
     * 用户注册
     */
    @PostMapping("/register")
    public ResponseEntity<?> register(@RequestBody RegisterRequest registerRequest) {
        try {
            // 检查密码确认
            if (!registerRequest.getPassword().equals(registerRequest.getConfirmPassword())) {
                return ResponseEntity.badRequest()
                    .body(new ApiResponse(false, "密码确认不匹配"));
            }
            
            // 创建用户
            User user = new User();
            user.setUsername(registerRequest.getUsername());
            user.setEmail(registerRequest.getEmail());
            user.setPhone(registerRequest.getPhone());
            user.setRole(User.UserRole.STUDENT); // 默认学生角色
            
            User savedUser = userService.register(user, registerRequest.getPassword());
            
            // 创建对应的学生档案
            Student student = new Student();
            student.setUser(savedUser);
            student.setStudentNo(registerRequest.getStudentNo());
            student.setName(registerRequest.getName());
            student.setCollege(registerRequest.getCollege());
            student.setMajor(registerRequest.getMajor());
            student.setStudentClass(registerRequest.getStudentClass());
            student.setGrade(registerRequest.getGrade());
            
            studentService.createStudentProfile(savedUser, student);
            
            log.info("用户注册成功: {}", registerRequest.getUsername());
            return ResponseEntity.ok(new ApiResponse(true, "注册成功"));
            
        } catch (Exception e) {
            log.error("用户注册失败: {}", registerRequest.getUsername(), e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "注册失败: " + e.getMessage()));
        }
    }
    
    /**
     * 获取当前用户信息
     */
    @GetMapping("/me")
    @PreAuthorize("isAuthenticated()")
    public ResponseEntity<?> getCurrentUser(Authentication authentication) {
        try {
            String username = authentication.getName();
            User user = userService.findByUsername(username)
                    .orElseThrow(() -> new BusinessException("用户不存在"));
            
            UserDto userDto = UserDto.fromUser(user);
            
            // 如果是学生，获取学生信息
            if (user.getRole() == User.UserRole.STUDENT) {
                Student student = studentService.findByUserId(user.getId())
                        .orElse(null);
                if (student != null) {
                    userDto.setStudent(StudentDto.fromStudent(student));
                }
            }
            
            return ResponseEntity.ok(userDto);
            
        } catch (Exception e) {
            log.error("获取当前用户信息失败", e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "获取用户信息失败"));
        }
    }
    
    /**
     * 刷新Token
     */
    @PostMapping("/refresh")
    @PreAuthorize("isAuthenticated()")
    public ResponseEntity<?> refreshToken(Authentication authentication) {
        try {
            String username = authentication.getName();
            String newToken = tokenProvider.generateToken(authentication);
            
            return ResponseEntity.ok(new TokenResponse(newToken, "Bearer"));
            
        } catch (Exception e) {
            log.error("刷新Token失败", e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "刷新Token失败"));
        }
    }
    
    /**
     * 用户登出
     */
    @PostMapping("/logout")
    @PreAuthorize("isAuthenticated()")
    public ResponseEntity<?> logout(Authentication authentication, 
                                   HttpServletRequest request) {
        try {
            // 从Token中提取用户ID
            String token = tokenProvider.resolveToken(request);
            if (token != null && tokenProvider.validateToken(token)) {
                Long userId = tokenProvider.getUserIdFromToken(token);
                
                // 将Token加入黑名单
                String blacklistKey = "token:blacklist:" + token;
                redisTemplate.opsForValue().set(blacklistKey, "1", 
                    Duration.ofMillis(tokenProvider.getExpirationTime()));
            }
            
            log.info("用户登出成功: {}", authentication.getName());
            return ResponseEntity.ok(new ApiResponse(true, "登出成功"));
            
        } catch (Exception e) {
            log.error("用户登出失败", e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "登出失败"));
        }
    }
    
    /**
     * 修改密码
     */
    @PostMapping("/change-password")
    @PreAuthorize("isAuthenticated()")
    public ResponseEntity<?> changePassword(
            Authentication authentication,
            @RequestBody ChangePasswordRequest request) {
        try {
            String username = authentication.getName();
            User user = userService.findByUsername(username)
                    .orElseThrow(() -> new BusinessException("用户不存在"));
            
            userService.changePassword(user.getId(), request.getOldPassword(), 
                                     request.getNewPassword());
            
            return ResponseEntity.ok(new ApiResponse(true, "密码修改成功"));
            
        } catch (Exception e) {
            log.error("修改密码失败", e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "密码修改失败: " + e.getMessage()));
        }
    }
}
```

#### 7.2.2 StudentController - 学生管理控制器
```java
@RestController
@RequestMapping("/api/students")
@PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER') or hasRole('STUDENT')")
public class StudentController {
    
    @Autowired
    private StudentService studentService;
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private AcademicRecordService academicRecordService;
    
    /**
     * 分页查询学生
     */
    @GetMapping
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER')")
    public ResponseEntity<Page<StudentDto>> findStudents(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(defaultValue = "studentNo") String sortBy,
            @RequestParam(defaultValue = "asc") String sortDir,
            @RequestParam(required = false) String studentNo,
            @RequestParam(required = false) String name,
            @RequestParam(required = false) String college,
            @RequestParam(required = false) String major,
            @RequestParam(required = false) String studentClass,
            @RequestParam(required = false) String grade) {
        
        Sort sort = Sort.by(Sort.Direction.fromString(sortDir), sortBy);
        Pageable pageable = PageRequest.of(page, size, sort);
        
        Page<Student> students = studentService.findStudents(studentNo, name, college, 
                                                           major, studentClass, grade, pageable);
        
        Page<StudentDto> studentDtos = students.map(StudentDto::fromStudent);
        
        return ResponseEntity.ok(studentDtos);
    }
    
    /**
     * 根据ID获取学生详情
     */
    @GetMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER') or #id == @studentService.findByUserId(authentication.principal.id).orElse(null)?.id")
    public ResponseEntity<StudentDetailDto> getStudentDetail(@PathVariable Long id) {
        try {
            Student student = studentService.getStudentCompleteInfo(id);
            StudentDetailDto studentDetailDto = StudentDetailDto.fromStudent(student);
            
            // 计算GPA
            String currentYear = LocalDate.now().getYear() + "-" + (LocalDate.now().getYear() + 1);
            BigDecimal gpa = studentService.calculateStudentGPA(id, currentYear);
            studentDetailDto.setCurrentGpa(gpa);
            
            return ResponseEntity.ok(studentDetailDto);
            
        } catch (Exception e) {
            log.error("获取学生详情失败: {}", id, e);
            return ResponseEntity.notFound().build();
        }
    }
    
    /**
     * 创建学生档案
     */
    @PostMapping
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse> createStudent(@RequestBody CreateStudentRequest request) {
        try {
            // 创建用户
            User user = new User();
            user.setUsername(request.getUsername());
            user.setEmail(request.getEmail());
            user.setPhone(request.getPhone());
            user.setRole(User.UserRole.STUDENT);
            
            User savedUser = userService.register(user, request.getPassword());
            
            // 创建学生档案
            Student student = new Student();
            student.setUser(savedUser);
            student.setStudentNo(request.getStudentNo());
            student.setName(request.getName());
            student.setGender(request.getGender());
            student.setBirthDate(request.getBirthDate());
            student.setCollege(request.getCollege());
            student.setMajor(request.getMajor());
            student.setStudentClass(request.getStudentClass());
            student.setGrade(request.getGrade());
            student.setContact(request.getContact());
            student.setEmergencyContact(request.getEmergencyContact());
            student.setAddress(request.getAddress());
            
            Student savedStudent = studentService.createStudentProfile(savedUser, student);
            
            return ResponseEntity.ok(new ApiResponse(true, "学生档案创建成功", 
                StudentDto.fromStudent(savedStudent)));
            
        } catch (Exception e) {
            log.error("创建学生档案失败", e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "创建失败: " + e.getMessage()));
        }
    }
    
    /**
     * 更新学生信息
     */
    @PutMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or #id == @studentService.findByUserId(authentication.principal.id).orElse(null)?.id")
    public ResponseEntity<ApiResponse> updateStudent(@PathVariable Long id, 
                                                   @RequestBody UpdateStudentRequest request) {
        try {
            Student student = new Student();
            student.setId(id);
            student.setStudentNo(request.getStudentNo());
            student.setName(request.getName());
            student.setGender(request.getGender());
            student.setBirthDate(request.getBirthDate());
            student.setCollege(request.getCollege());
            student.setMajor(request.getMajor());
            student.setStudentClass(request.getStudentClass());
            student.setGrade(request.getGrade());
            student.setContact(request.getContact());
            student.setEmergencyContact(request.getEmergencyContact());
            student.setAddress(request.getAddress());
            student.setAvatarUrl(request.getAvatarUrl());
            
            Student updatedStudent = studentService.updateStudentInfo(id, student);
            
            return ResponseEntity.ok(new ApiResponse(true, "学生信息更新成功",
                StudentDto.fromStudent(updatedStudent)));
            
        } catch (Exception e) {
            log.error("更新学生信息失败: {}", id, e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "更新失败: " + e.getMessage()));
        }
    }
    
    /**
     * 获取学生学业记录
     */
    @GetMapping("/{id}/academic-records")
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER') or #id == @studentService.findByUserId(authentication.principal.id).orElse(null)?.id")
    public ResponseEntity<Page<AcademicRecordDto>> getStudentAcademicRecords(
            @PathVariable Long id,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(required = false) String academicYear,
            @RequestParam(required = false) String semester) {
        
        try {
            Pageable pageable = PageRequest.of(page, size);
            Page<AcademicRecord> records = academicRecordService.findByStudentIdAndConditions(
                id, academicYear, semester, pageable);
            
            Page<AcademicRecordDto> recordDtos = records.map(AcademicRecordDto::fromAcademicRecord);
            
            return ResponseEntity.ok(recordDtos);
            
        } catch (Exception e) {
            log.error("获取学生学业记录失败: {}", id, e);
            return ResponseEntity.notFound().build();
        }
    }
    
    /**
     * 计算学生GPA
     */
    @GetMapping("/{id}/gpa")
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER') or #id == @studentService.findByUserId(authentication.principal.id).orElse(null)?.id")
    public ResponseEntity<GpaResponse> calculateGpa(@PathVariable Long id,
                                                   @RequestParam(required = false) String academicYear) {
        try {
            String year = academicYear != null ? academicYear : 
                LocalDate.now().getYear() + "-" + (LocalDate.now().getYear() + 1);
            
            BigDecimal gpa = studentService.calculateStudentGPA(id, year);
            
            GpaResponse response = GpaResponse.builder()
                .studentId(id)
                .academicYear(year)
                .gpa(gpa)
                .build();
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("计算GPA失败: {}", id, e);
            return ResponseEntity.notFound().build();
        }
    }
    
    /**
     * 获取学生统计信息
     */
    @GetMapping("/statistics")
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER')")
    public ResponseEntity<StudentStatisticsDto> getStatistics() {
        try {
            Map<String, Long> collegeStats = studentService.getCollegeStatistics();
            Map<String, Long> majorStats = studentService.getMajorStatistics();
            
            StudentStatisticsDto stats = StudentStatisticsDto.builder()
                .collegeStatistics(collegeStats)
                .majorStatistics(majorStats)
                .build();
            
            return ResponseEntity.ok(stats);
            
        } catch (Exception e) {
            log.error("获取学生统计信息失败", e);
            return ResponseEntity.badRequest()
                .body(new StudentStatisticsDto());
        }
    }
    
    /**
     * 导出学生信息
     */
    @GetMapping("/export")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<byte[]> exportStudents(
            @RequestParam(required = false) String college,
            @RequestParam(required = false) String major,
            @RequestParam(required = false) String grade,
            @RequestParam(defaultValue = "xlsx") String format) {
        
        try {
            List<Student> students = studentService.exportStudents(college, major, grade);
            
            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
            
            // 根据格式导出
            switch (format.toLowerCase()) {
                case "xlsx":
                    // 使用Apache POI导出Excel
                    exportToExcel(students, outputStream);
                    break;
                case "csv":
                    // 导出CSV
                    exportToCsv(students, outputStream);
                    break;
                default:
                    throw new BusinessException("不支持的导出格式");
            }
            
            byte[] content = outputStream.toByteArray();
            
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
            headers.setContentDispositionFormData("attachment", 
                "students_export_" + LocalDate.now() + "." + format);
            
            return ResponseEntity.ok()
                .headers(headers)
                .body(content);
                
        } catch (Exception e) {
            log.error("导出学生信息失败", e);
            return ResponseEntity.badRequest().build();
        }
    }
    
    private void exportToExcel(List<Student> students, OutputStream outputStream) throws IOException {
        // 使用Apache POI实现Excel导出
        // 这里为示例代码，实际需要引入POI依赖
        log.info("导出Excel格式学生信息，数量: {}", students.size());
    }
    
    private void exportToCsv(List<Student> students, OutputStream outputStream) throws IOException {
        // 实现CSV导出
        try (PrintWriter writer = new PrintWriter(new OutputStreamWriter(outputStream, "UTF-8"))) {
            // 写入CSV头部
            writer.println("学号,姓名,性别,学院,专业,班级,年级,联系方式");
            
            // 写入数据
            for (Student student : students) {
                writer.printf("%s,%s,%s,%s,%s,%s,%s,%s%n",
                    student.getStudentNo(),
                    student.getName(),
                    student.getGender(),
                    student.getCollege(),
                    student.getMajor(),
                    student.getStudentClass(),
                    student.getGrade(),
                    student.getContact()
                );
            }
        }
    }
}
```

#### 7.2.3 ScholarshipController - 奖学金管理控制器
```java
@RestController
@RequestMapping("/api/scholarships")
@PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER') or hasRole('STUDENT')")
public class ScholarshipController {
    
    @Autowired
    private ScholarshipTypeService scholarshipTypeService;
    
    @Autowired
    private ReviewService reviewService;
    
    @Autowired
    private StudentService studentService;
    
    @Autowired
    private UserService userService;
    
    /**
     * 获取所有奖学金类型
     */
    @GetMapping("/types")
    public ResponseEntity<Page<ScholarshipTypeDto>> findScholarshipTypes(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(defaultValue = "name") String sortBy,
            @RequestParam(defaultValue = "asc") String sortDir,
            @RequestParam(required = false) String name,
            @RequestParam(required = false) String category,
            @RequestParam(required = false) Boolean isActive) {
        
        Sort sort = Sort.by(Sort.Direction.fromString(sortDir), sortBy);
        Pageable pageable = PageRequest.of(page, size, sort);
        
        Page<ScholarshipType> scholarshipTypes = scholarshipTypeService.findScholarshipTypes(
            name, category, isActive, pageable);
        
        Page<ScholarshipTypeDto> typeDtos = scholarshipTypes.map(ScholarshipTypeDto::fromScholarshipType);
        
        return ResponseEntity.ok(typeDtos);
    }
    
    /**
     * 获取当前可申请的奖学金
     */
    @GetMapping("/types/available")
    public ResponseEntity<List<ScholarshipTypeDto>> getAvailableScholarships() {
        try {
            List<ScholarshipType> availableScholarships = scholarshipTypeService.getAvailableScholarships();
            List<ScholarshipTypeDto> typeDtos = availableScholarships.stream()
                .map(ScholarshipTypeDto::fromScholarshipType)
                .collect(Collectors.toList());
            
            return ResponseEntity.ok(typeDtos);
            
        } catch (Exception e) {
            log.error("获取可申请奖学金失败", e);
            return ResponseEntity.badRequest().build();
        }
    }
    
    /**
     * 获取奖学金详情
     */
    @GetMapping("/types/{id}")
    public ResponseEntity<ScholarshipTypeDetailDto> getScholarshipTypeDetail(@PathVariable Long id) {
        try {
            ScholarshipType scholarshipType = scholarshipTypeService.findById(id)
                .orElseThrow(() -> new BusinessException("奖学金类型不存在"));
            
            ScholarshipTypeDetailDto detailDto = ScholarshipTypeDetailDto.fromScholarshipType(scholarshipType);
            
            // 获取申请统计
            ReviewStatisticsDto stats = reviewService.getStatisticsByScholarshipTypeId(id);
            detailDto.setStatistics(stats);
            
            return ResponseEntity.ok(detailDto);
            
        } catch (Exception e) {
            log.error("获取奖学金详情失败: {}", id, e);
            return ResponseEntity.notFound().build();
        }
    }
    
    /**
     * 申请奖学金
     */
    @PostMapping("/applications")
    @PreAuthorize("hasRole('STUDENT')")
    public ResponseEntity<ApiResponse> applyScholarship(
            Authentication authentication,
            @RequestBody ScholarshipApplicationRequest request) {
        
        try {
            String username = authentication.getName();
            User user = userService.findByUsername(username)
                .orElseThrow(() -> new BusinessException("用户不存在"));
            
            Student student = studentService.findByUserId(user.getId())
                .orElseThrow(() -> new BusinessException("学生档案不存在"));
            
            // 检查申请条件
            ScholarshipType scholarshipType = scholarshipTypeService.findById(request.getScholarshipTypeId())
                .orElseThrow(() -> new BusinessException("奖学金类型不存在"));
            
            // 验证申请时间
            if (!scholarshipType.isApplicationOpen()) {
                throw new BusinessException("当前不在申请时间内");
            }
            
            // 创建评审记录
            Review review = new Review();
            review.setStudent(student);
            review.setScholarshipType(scholarshipType);
            review.setApplicationStatus(Review.ApplicationStatus.SUBMITTED);
            review.setSubmittedAt(LocalDateTime.now());
            
            Review savedReview = reviewService.save(review);
            
            log.info("学生{}申请奖学金{}", student.getName(), scholarshipType.getName());
            
            return ResponseEntity.ok(new ApiResponse(true, "申请成功", 
                ReviewDto.fromReview(savedReview)));
            
        } catch (Exception e) {
            log.error("申请奖学金失败", e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "申请失败: " + e.getMessage()));
        }
    }
    
    /**
     * 获取我的申请列表
     */
    @GetMapping("/my-applications")
    @PreAuthorize("hasRole('STUDENT')")
    public ResponseEntity<Page<ReviewDto>> getMyApplications(
            Authentication authentication,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        
        try {
            String username = authentication.getName();
            User user = userService.findByUsername(username)
                .orElseThrow(() -> new BusinessException("用户不存在"));
            
            Student student = studentService.findByUserId(user.getId())
                .orElseThrow(() -> new BusinessException("学生档案不存在"));
            
            Pageable pageable = PageRequest.of(page, size, Sort.by("createdAt").descending());
            Page<Review> reviews = reviewService.findByStudentId(student.getId(), pageable);
            
            Page<ReviewDto> reviewDtos = reviews.map(ReviewDto::fromReview);
            
            return ResponseEntity.ok(reviewDtos);
            
        } catch (Exception e) {
            log.error("获取我的申请列表失败", e);
            return ResponseEntity.badRequest().build();
        }
    }
    
    /**
     * 撤销申请
     */
    @PostMapping("/applications/{id}/withdraw")
    @PreAuthorize("hasRole('STUDENT')")
    public ResponseEntity<ApiResponse> withdrawApplication(
            @PathVariable Long id,
            Authentication authentication) {
        
        try {
            String username = authentication.getName();
            User user = userService.findByUsername(username)
                .orElseThrow(() -> new BusinessException("用户不存在"));
            
            Student student = studentService.findByUserId(user.getId())
                .orElseThrow(() -> new BusinessException("学生档案不存在"));
            
            Review review = reviewService.findById(id)
                .orElseThrow(() -> new BusinessException("申请记录不存在"));
            
            // 验证申请权限
            if (!review.getStudent().getId().equals(student.getId())) {
                throw new BusinessException("无权操作该申请");
            }
            
            // 检查申请状态
            if (review.getApplicationStatus() == Review.ApplicationStatus.REJECTED) {
                throw new BusinessException("已驳回的申请无法撤销");
            }
            
            review.setApplicationStatus(Review.ApplicationStatus.WITHDRAWN);
            reviewService.save(review);
            
            log.info("学生{}撤销申请{}", student.getName(), review.getScholarshipType().getName());
            
            return ResponseEntity.ok(new ApiResponse(true, "撤销申请成功"));
            
        } catch (Exception e) {
            log.error("撤销申请失败: {}", id, e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "撤销失败: " + e.getMessage()));
        }
    }
    
    /**
     * 管理员创建奖学金类型
     */
    @PostMapping("/types")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse> createScholarshipType(@RequestBody CreateScholarshipTypeRequest request) {
        try {
            ScholarshipType scholarshipType = new ScholarshipType();
            scholarshipType.setName(request.getName());
            scholarshipType.setCode(request.getCode());
            scholarshipType.setCategory(request.getCategory());
            scholarshipType.setAmount(request.getAmount());
            scholarshipType.setCondition(request.getCondition());
            scholarshipType.setDescription(request.getDescription());
            scholarshipType.setRequirements(request.getRequirements());
            scholarshipType.setApplicationStartDate(request.getApplicationStartDate());
            scholarshipType.setApplicationEndDate(request.getApplicationEndDate());
            scholarshipType.setMaxRecipients(request.getMaxRecipients());
            scholarshipType.setIsActive(true);
            
            ScholarshipType savedScholarshipType = scholarshipTypeService.save(scholarshipType);
            
            return ResponseEntity.ok(new ApiResponse(true, "奖学金类型创建成功",
                ScholarshipTypeDto.fromScholarshipType(savedScholarshipType)));
            
        } catch (Exception e) {
            log.error("创建奖学金类型失败", e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "创建失败: " + e.getMessage()));
        }
    }
    
    /**
     * 管理员更新奖学金类型
     */
    @PutMapping("/types/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public ResponseEntity<ApiResponse> updateScholarshipType(
            @PathVariable Long id,
            @RequestBody UpdateScholarshipTypeRequest request) {
        
        try {
            ScholarshipType scholarshipType = scholarshipTypeService.findById(id)
                .orElseThrow(() -> new BusinessException("奖学金类型不存在"));
            
            // 更新允许修改的字段
            scholarshipType.setName(request.getName());
            scholarshipType.setCategory(request.getCategory());
            scholarshipType.setAmount(request.getAmount());
            scholarshipType.setCondition(request.getCondition());
            scholarshipType.setDescription(request.getDescription());
            scholarshipType.setRequirements(request.getRequirements());
            scholarshipType.setApplicationStartDate(request.getApplicationStartDate());
            scholarshipType.setApplicationEndDate(request.getApplicationEndDate());
            scholarshipType.setMaxRecipients(request.getMaxRecipients());
            scholarshipType.setIsActive(request.getIsActive());
            
            ScholarshipType savedScholarshipType = scholarshipTypeService.save(scholarshipType);
            
            return ResponseEntity.ok(new ApiResponse(true, "奖学金类型更新成功",
                ScholarshipTypeDto.fromScholarshipType(savedScholarshipType)));
            
        } catch (Exception e) {
            log.error("更新奖学金类型失败: {}", id, e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "更新失败: " + e.getMessage()));
        }
    }
    
    /**
     * 获取申请管理列表（管理员/教师用）
     */
    @GetMapping("/applications")
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER')")
    public ResponseEntity<Page<ReviewDto>> findApplications(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(defaultValue = "createdAt") String sortBy,
            @RequestParam(defaultValue = "desc") String sortDir,
            @RequestParam(required = false) String studentName,
            @RequestParam(required = false) String scholarshipName,
            @RequestParam(required = false) Review.ApplicationStatus applicationStatus,
            @RequestParam(required = false) Review.ReviewStatus reviewStatus) {
        
        Sort sort = Sort.by(Sort.Direction.fromString(sortDir), sortBy);
        Pageable pageable = PageRequest.of(page, size, sort);
        
        Page<Review> reviews = reviewService.findReviews(studentName, scholarshipName, 
            applicationStatus, reviewStatus, pageable);
        
        Page<ReviewDto> reviewDtos = reviews.map(ReviewDto::fromReview);
        
        return ResponseEntity.ok(reviewDtos);
    }
    
    /**
     * 审核申请
     */
    @PostMapping("/applications/{id}/review")
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER')")
    public ResponseEntity<ApiResponse> reviewApplication(
            @PathVariable Long id,
            Authentication authentication,
            @RequestBody ReviewApplicationRequest request) {
        
        try {
            String username = authentication.getName();
            User reviewer = userService.findByUsername(username)
                .orElseThrow(() -> new BusinessException("用户不存在"));
            
            Review review = reviewService.findById(id)
                .orElseThrow(() -> new BusinessException("申请记录不存在"));
            
            // 设置评审信息
            review.setReviewer(reviewer);
            review.setAcademicScore(request.getAcademicScore());
            review.setConductScore(request.getConductScore());
            review.setExtraScore(request.getExtraScore());
            review.setReviewOpinion(request.getReviewOpinion());
            review.setReviewerNotes(request.getReviewerNotes());
            review.setReviewedAt(LocalDateTime.now());
            review.setApplicationStatus(Review.ApplicationStatus.UNDER_REVIEW);
            
            if (request.getReviewStatus() == Review.ReviewStatus.APPROVED) {
                review.setReviewStatus(Review.ReviewStatus.APPROVED);
                review.setApprovedAt(LocalDateTime.now());
            } else if (request.getReviewStatus() == Review.ReviewStatus.REJECTED) {
                review.setReviewStatus(Review.ReviewStatus.REJECTED);
                review.setRejectedReason(request.getRejectedReason());
            }
            
            Review savedReview = reviewService.save(review);
            
            log.info("管理员{}审核申请{}", reviewer.getUsername(), savedReview.getId());
            
            return ResponseEntity.ok(new ApiResponse(true, "审核完成",
                ReviewDto.fromReview(savedReview)));
            
        } catch (Exception e) {
            log.error("审核申请失败: {}", id, e);
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "审核失败: " + e.getMessage()));
        }
    }
    
    /**
     * 获取申请统计
     */
    @GetMapping("/statistics")
    @PreAuthorize("hasRole('ADMIN') or hasRole('TEACHER')")
    public ResponseEntity<ScholarshipStatisticsDto> getStatistics() {
        try {
            ScholarshipStatisticsDto stats = reviewService.getOverallStatistics();
            return ResponseEntity.ok(stats);
            
        } catch (Exception e) {
            log.error("获取申请统计失败", e);
            return ResponseEntity.badRequest()
                .body(new ScholarshipStatisticsDto());
        }
    }
}
```

## 8. 前端页面详细设计

### 8.1 页面结构设计

#### 8.1.1 基础布局模板
```html
<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '高校奖学金管理系统'">高校奖学金管理系统</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/main.css}" rel="stylesheet">
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <!-- Logo和系统名称 -->
            <a class="navbar-brand" th:href="@{/dashboard}">
                <i class="fas fa-graduation-cap me-2"></i>
                奖学金管理系统
            </a>
            
            <!-- 移动端折叠按钮 -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- 导航菜单 -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- 学生菜单 -->
                    <li class="nav-item" sec:authorize="hasRole('STUDENT')">
                        <a class="nav-link" th:href="@{/student/dashboard}">
                            <i class="fas fa-home me-1"></i>个人中心
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('STUDENT')">
                        <a class="nav-link" th:href="@{/student/scholarships}">
                            <i class="fas fa-medal me-1"></i>奖学金申请
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('STUDENT')">
                        <a class="nav-link" th:href="@{/student/my-applications}">
                            <i class="fas fa-file-alt me-1"></i>我的申请
                        </a>
                    </li>
                    
                    <!-- 管理员/教师菜单 -->
                    <li class="nav-item" sec:authorize="hasAnyRole('ADMIN', 'TEACHER')">
                        <a class="nav-link" th:href="@{/admin/dashboard}">
                            <i class="fas fa-chart-bar me-1"></i>数据统计
                        </a>
                    </li>
                    <li class="nav-item dropdown" sec:authorize="hasAnyRole('ADMIN', 'TEACHER')">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-users me-1"></i>学生管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" th:href="@{/admin/students}">学生列表</a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/students/create}">新增学生</a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/students/import}">批量导入</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown" sec:authorize="hasAnyRole('ADMIN', 'TEACHER')">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-medal me-1"></i>奖学金管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" th:href="@{/admin/scholarships/types}">奖学金类型</a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/scholarships/applications}">申请审核</a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/scholarships/statistics}">申请统计</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" th:href="@{/admin/announcements}">
                            <i class="fas fa-bullhorn me-1"></i>公示管理
                        </a>
                    </li>
                    <li class="nav-item dropdown" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-cog me-1"></i>系统管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" th:href="@{/admin/users}">用户管理</a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/system/logs}">操作日志</a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/system/config}">系统配置</a></li>
                        </ul>
                    </li>
                </ul>
                
                <!-- 用户菜单 -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span sec:authentication="name">用户名</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" th:href="@{/profile}">个人资料</a></li>
                            <li><a class="dropdown-item" th:href="@{/change-password}">修改密码</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="dropdown-item">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <button type="submit" class="btn btn-link text-decoration-none p-0">
                                        <i class="fas fa-sign-out-alt me-1"></i>退出登录
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb" th:if="${breadcrumbs}">
        <div class="container-fluid">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a th:href="@{/dashboard}">
                        <i class="fas fa-home"></i> 首页
                    </a>
                </li>
                <li th:each="breadcrumb,iterStat : ${breadcrumbs}" 
                    th:class="${iterStat.last} ? 'breadcrumb-item active' : 'breadcrumb-item'">
                    <span th:if="${iterStat.last}" th:text="${breadcrumb.title}">当前页面</span>
                    <a th:unless="${iterStat.last}" th:href="${breadcrumb.url}" th:text="${breadcrumb.title}">上级页面</a>
                </li>
            </ol>
        </div>
    </nav>
    
    <!-- 主内容区域 -->
    <main class="container-fluid mt-3">
        <!-- 消息提示 -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${successMessage}">成功消息</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${errorMessage}">错误消息</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${warningMessage}" class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${warningMessage}">警告消息</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- 页面内容 -->
        <div th:replace="~{::content}">页面内容将在这里显示</div>
    </main>
    
    <!-- 页脚 -->
    <footer class="bg-light mt-5 py-3">
        <div class="container text-center">
            <p class="mb-0 text-muted">
                © 2024 高校奖学金管理系统. 
                <span sec:authorize="isAuthenticated()">
                    当前用户: <span sec:authentication="name">用户名</span> 
                    角色: <span sec:authentication="authorities[0]">角色</span>
                </span>
            </p>
        </div>
    </footer>
    
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/js/common.js}"></script>
    <script th:replace="${pageScript} ?: ~{}">页面特定JavaScript将在这里加载</script>
</body>
</html>
```

#### 8.1.2 学生个人中心页面
```html
<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:fragment="content">
<head>
    <title>个人中心 - 高校奖学金管理系统</title>
    <link th:href="@{/css/student-dashboard.css}" rel="stylesheet">
</head>

<div class="row">
    <!-- 左侧信息卡片 -->
    <div class="col-lg-4">
        <!-- 学生基本信息卡片 -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <div class="mb-3">
                    <img th:src="${student.avatarUrl} ?: '/images/default-avatar.png'" 
                         class="rounded-circle" width="100" height="100" alt="头像">
                </div>
                <h5 th:text="${student.name}">学生姓名</h5>
                <p class="text-muted mb-1" th:text="${student.studentNo}">学号</p>
                <p class="text-muted mb-1" th:text="${student.college} + ' ' + ${student.major}">学院 专业</p>
                <p class="text-muted" th:text="${student.studentClass} + ' ' + ${student.grade}">班级 年级</p>
                <div class="d-grid">
                    <a href="/student/profile/edit" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-edit me-1"></i>编辑信息
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 成绩概览卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>成绩概览</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary" th:text="${currentGpa} ?: '0.00'">3.85</h4>
                        <small class="text-muted">当前GPA</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success" th:text="${totalCredits} ?: '0.0'">128.5</h4>
                        <small class="text-muted">已修学分</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <h5 th:text="${courseCount} ?: '0'">35</h5>
                        <small class="text-muted">已修课程</small>
                    </div>
                    <div class="col-6">
                        <h5 th:text="${avgScore} ?: '0.0'">87.5</h5>
                        <small class="text-muted">平均成绩</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 快捷操作卡片 -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>快捷操作</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/student/scholarships" class="btn btn-primary btn-sm">
                        <i class="fas fa-medal me-1"></i>申请奖学金
                    </a>
                    <a href="/student/my-applications" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-file-alt me-1"></i>我的申请
                    </a>
                    <a href="/student/announcements" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-bullhorn me-1"></i>查看公示
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 右侧内容区域 -->
    <div class="col-lg-8">
        <!-- 当前奖学金状态 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>奖学金申请状态</h6>
                <a href="/student/scholarships" class="btn btn-sm btn-outline-primary">查看全部</a>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(pendingApplications)}" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>暂无待处理的奖学金申请</p>
                    <a href="/student/scholarships" class="btn btn-primary">立即申请</a>
                </div>
                <div th:unless="${#lists.isEmpty(pendingApplications)}">
                    <div th:each="application : ${pendingApplications}" class="border rounded p-3 mb-3">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 th:text="${application.scholarshipType.name}">国家奖学金</h6>
                                <p class="text-muted mb-1">
                                    申请时间: <span th:text="${#temporals.format(application.submittedAt, 'yyyy-MM-dd HH:mm')}">2024-01-01</span>
                                </p>
                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar" 
                                         th:classappend="${application.applicationStatus == 'SUBMITTED'} ? 'bg-warning' : 'bg-info'"
                                         th:style="'width: ' + 
                                         (${application.applicationStatus == 'SUBMITTED'} ? '60%' : 
                                          ${application.applicationStatus == 'UNDER_REVIEW'} ? '80%' : 
                                          ${application.applicationStatus == 'APPROVED'} ? '100%' : '40%')">
                                    </div>
                                </div>
                                <small class="text-muted" 
                                       th:text="${application.applicationStatus == 'SUBMITTED'} ? '已提交，待审核' :
                                               ${application.applicationStatus == 'UNDER_REVIEW'} ? '审核中' :
                                               ${application.applicationStatus == 'APPROVED'} ? '已通过' : '草稿'">
                                    已提交，待审核
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-primary" th:text="${application.scholarshipType.amount} + '元'">8000元</span>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            th:onclick="'viewApplication(' + ${application.id} + ')'">
                                        查看详情
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 最新成绩记录 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>最新成绩</h6>
                <a href="/student/academic-records" class="btn btn-sm btn-outline-primary">查看全部</a>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(recentAcademicRecords)}" class="text-center text-muted py-4">
                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                    <p>暂无成绩记录</p>
                </div>
                <div th:unless="${#lists.isEmpty(recentAcademicRecords)}">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>课程名称</th>
                                    <th>学分</th>
                                    <th>成绩</th>
                                    <th>学期</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="record : ${recentAcademicRecords}">
                                    <td th:text="${record.courseName}">高等数学</td>
                                    <td th:text="${record.courseCredit}">3.0</td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${record.courseScore >= 90} ? 'bg-success' :
                                                            ${record.courseScore >= 80} ? 'bg-info' :
                                                            ${record.courseScore >= 70} ? 'bg-warning' :
                                                            ${record.courseScore >= 60} ? 'bg-secondary' : 'bg-danger'"
                                              th:text="${record.courseScore}">85</span>
                                    </td>
                                    <td th:text="${record.academicYear} + ' ' + ${record.semester}">2023-2024 第一学期</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 系统公告 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-bullhorn me-2"></i>系统公告</h6>
                <a href="/student/announcements" class="btn btn-sm btn-outline-primary">查看全部</a>
            </div>
            <div class="card-body">
                <div th:if="${#lists.isEmpty(recentAnnouncements)}" class="text-center text-muted py-4">
                    <i class="fas fa-bullhorn fa-3x mb-3"></i>
                    <p>暂无公告</p>
                </div>
                <div th:unless="${#lists.isEmpty(recentAnnouncements)}">
                    <div th:each="announcement : ${recentAnnouncements}" class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    <a href="#" class="text-decoration-none" 
                                       th:text="${announcement.title}"
                                       th:onclick="'viewAnnouncement(' + ${announcement.id} + ')'">
                                        关于2024年春季学期奖学金申请的通知
                                    </a>
                                </h6>
                                <p class="text-muted small mb-1" th:text="${announcement.summary}">
                                    2024年春季学期各类奖学金申请工作即将开始...
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    <span th:text="${#temporals.format(announcement.publishDate, 'yyyy-MM-dd')}">2024-01-01</span>
                                    <span class="ms-2">
                                        <i class="fas fa-eye me-1"></i>
                                        <span th:text="${announcement.viewCount}">123</span>次查看
                                    </span>
                                </small>
                            </div>
                            <span th:if="${announcement.isTop}" class="badge bg-danger">置顶</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
function viewApplication(applicationId) {
    // 查看申请详情
    window.location.href = '/student/applications/' + applicationId;
}

function viewAnnouncement(announcementId) {
    // 查看公告详情
    window.location.href = '/student/announcements/' + announcementId;
}

// 页面加载完成后的初始化操作
$(document).ready(function() {
    // 初始化DataTables（如果需要）
    // ...
    
    // 定时刷新数据（可选）
    // setInterval(function() {
    //     location.reload();
    // }, 30000); // 30秒刷新一次
});
</script>
</html>
```

### 8.2 JavaScript模块设计

#### 8.2.1 通用JavaScript模块
```javascript
// common.js - 通用JavaScript函数
const CommonJS = {
    // 显示加载状态
    showLoading: function(element) {
        const loadingHtml = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <div class="mt-2">加载中...</div>
            </div>
        `;
        $(element).html(loadingHtml);
    },
    
    // 隐藏加载状态
    hideLoading: function(element, content) {
        $(element).html(content || '');
    },
    
    // 显示Toast消息
    showToast: function(message, type = 'info') {
        const toastClass = type === 'success' ? 'bg-success' : 
                          type === 'error' ? 'bg-danger' :
                          type === 'warning' ? 'bg-warning' : 'bg-info';
        
        const toastHtml = `
            <div class="toast align-items-center text-white ${toastClass} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        $('#toast-container').append(toastHtml);
        const toastElement = $('#toast-container .toast').last()[0];
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // 自动移除Toast元素
        $(toastElement).on('hidden.bs.toast', function() {
            $(this).remove();
        });
    },
    
    // 确认对话框
    confirm: function(message, callback, title = '确认操作') {
        Swal.fire({
            title: title,
            text: message,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '确认',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed && typeof callback === 'function') {
                callback();
            }
        });
    },
    
    // 异步请求封装
    ajax: function(options) {
        const defaultOptions = {
            dataType: 'json',
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader('X-CSRFToken', $('input[name="_csrf"]').val());
            },
            error: function(xhr, status, error) {
                console.error('AJAX错误:', error);
                let message = '请求失败';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                } else if (xhr.status === 403) {
                    message = '权限不足';
                } else if (xhr.status === 500) {
                    message = '服务器内部错误';
                }
                CommonJS.showToast(message, 'error');
            }
        };
        
        return $.ajax(Object.assign(defaultOptions, options));
    },
    
    // 表单验证
    validateForm: function(formElement, rules) {
        const validator = $(formElement).validate({
            rules: rules,
            messages: {
                // 自定义错误消息
            },
            errorClass: 'is-invalid',
            validClass: 'is-valid',
            errorPlacement: function(error, element) {
                error.addClass('invalid-feedback');
                element.closest('.form-group, .mb-3').append(error);
            }
        });
        
        return validator;
    },
    
    // 格式化数字
    formatNumber: function(num, decimals = 2) {
        return Number(num).toFixed(decimals);
    },
    
    // 格式化日期
    formatDate: function(date, format = 'YYYY-MM-DD') {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        const seconds = String(d.getSeconds()).padStart(2, '0');
        
        return format
            .replace('YYYY', year)
            .replace('MM', month)
            .replace('DD', day)
            .replace('HH', hours)
            .replace('mm', minutes)
            .replace('ss', seconds);
    },
    
    // 防抖函数
    debounce: function(func, wait, immediate) {
        let timeout;
        return function executedFunction() {
            const context = this;
            const args = arguments;
            const later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            const callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    },
    
    // 节流函数
    throttle: function(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    },
    
    // 下载文件
    downloadFile: function(url, filename) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename || 'download';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
};

// 页面加载完成后初始化
$(document).ready(function() {
    // 初始化Toast容器
    if ($('#toast-container').length === 0) {
        $('body').append('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>');
    }
    
    // 全局错误处理
    $(document).ajaxError(function(event, xhr, settings, thrownError) {
        if (xhr.status === 401) {
            // 未授权，重定向到登录页
            window.location.href = '/login';
        }
    });
    
    // CSRF Token处理
    const csrfToken = $('input[name="_csrf"]').val();
    if (csrfToken) {
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader('X-CSRFToken', csrfToken);
                }
            }
        });
    }
});
```

#### 8.2.2 DataTables配置模块
```javascript
// datatables-config.js - DataTables配置
const DataTablesConfig = {
    // 默认配置
    defaultConfig: {
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh.json'
        },
        responsive: true,
        pageLength: 20,
        lengthMenu: [[10, 20, 50, 100, -1], [10, 20, 50, 100, "全部"]],
        processing: false,
        serverSide: true,
        stateSave: true,
        dom: 'Bfrtip',
        buttons: [
            'copy', 'excel', 'pdf', 'print', 'colvis'
        ]
    },
    
    // 学生列表配置
    studentTable: function(options = {}) {
        return Object.assign({}, this.defaultConfig, {
            ajax: {
                url: '/api/students',
                data: function(data) {
                    // 处理搜索参数
                    data.page = data.start / data.length + 1;
                    data.size = data.length;
                    data.sortBy = data.columns[data.order[0].column].data;
                    data.sortDir = data.order[0].dir;
                    delete data.columns;
                    delete data.order;
                    delete data.search;
                    return data;
                },
                dataSrc: function(json) {
                    return {
                        data: json.content,
                        recordsTotal: json.totalElements,
                        recordsFiltered: json.totalElements
                    };
                }
            },
            columns: [
                { data: 'studentNo', title: '学号' },
                { data: 'name', title: '姓名' },
                { data: 'college', title: '学院' },
                { data: 'major', title: '专业' },
                { data: 'studentClass', title: '班级' },
                { data: 'grade', title: '年级' },
                { 
                    data: 'isActive',
                    title: '状态',
                    render: function(data, type, row) {
                        return data ? '<span class="badge bg-success">正常</span>' : '<span class="badge bg-danger">禁用</span>';
                    }
                },
                {
                    data: 'id',
                    title: '操作',
                    orderable: false,
                    render: function(data, type, row) {
                        return `
                            <div class="btn-group btn-group-sm">
                                <a href="/admin/students/${data}/view" class="btn btn-outline-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="/admin/students/${data}/edit" class="btn btn-outline-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-outline-danger" onclick="deleteStudent(${data})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                }
            ],
            ...options
        });
    },
    
    // 奖学金申请列表配置
    applicationTable: function(options = {}) {
        return Object.assign({}, this.defaultConfig, {
            ajax: {
                url: '/api/scholarships/applications',
                data: function(data) {
                    data.page = data.start / data.length + 1;
                    data.size = data.length;
                    data.sortBy = data.columns[data.order[0].column].data;
                    data.sortDir = data.order[0].dir;
                    return data;
                },
                dataSrc: function(json) {
                    return {
                        data: json.content,
                        recordsTotal: json.totalElements,
                        recordsFiltered: json.totalElements
                    };
                }
            },
            columns: [
                { data: 'student.studentNo', title: '学号' },
                { data: 'student.name', title: '学生姓名' },
                { data: 'scholarshipType.name', title: '奖学金名称' },
                { data: 'scholarshipType.amount', title: '金额', 
                  render: function(data) { return data + '元'; } },
                { 
                    data: 'applicationStatus',
                    title: '申请状态',
                    render: function(data) {
                        const statusMap = {
                            'DRAFT': '<span class="badge bg-secondary">草稿</span>',
                            'SUBMITTED': '<span class="badge bg-warning">已提交</span>',
                            'UNDER_REVIEW': '<span class="badge bg-info">审核中</span>',
                            'APPROVED': '<span class="badge bg-success">已通过</span>',
                            'REJECTED': '<span class="badge bg-danger">已驳回</span>',
                            'WITHDRAWN': '<span class="badge bg-dark">已撤销</span>'
                        };
                        return statusMap[data] || data;
                    }
                },
                { data: 'totalScore', title: '综合评分' },
                { 
                    data: 'submittedAt',
                    title: '提交时间',
                    render: function(data) {
                        return data ? CommonJS.formatDate(data, 'YYYY-MM-DD HH:mm') : '';
                    }
                },
                {
                    data: 'id',
                    title: '操作',
                    orderable: false,
                    render: function(data, type, row) {
                        let actions = `
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewApplication(${data})">
                                    <i class="fas fa-eye"></i>
                                </button>
                        `;
                        
                        if (row.applicationStatus === 'SUBMITTED' || row.applicationStatus === 'UNDER_REVIEW') {
                            actions += `
                                <button class="btn btn-outline-success" onclick="approveApplication(${data})">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="rejectApplication(${data})">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                        }
                        
                        actions += '</div>';
                        return actions;
                    }
                }
            ],
            ...options
        });
    }
};

// 删除学生
function deleteStudent(studentId) {
    CommonJS.confirm('确定要删除该学生吗？此操作不可恢复。', function() {
        CommonJS.ajax({
            url: '/api/students/' + studentId,
            type: 'DELETE',
            success: function(response) {
                CommonJS.showToast('删除成功', 'success');
                $('#studentTable').DataTable().ajax.reload();
            }
        });
    });
}

// 查看申请
function viewApplication(applicationId) {
    // 打开申请详情模态框或页面
    window.open('/admin/scholarships/applications/' + applicationId, '_blank');
}

// 审核通过
function approveApplication(applicationId) {
    CommonJS.confirm('确定要通过该申请吗？', function() {
        CommonJS.ajax({
            url: '/api/scholarships/applications/' + applicationId + '/review',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                reviewStatus: 'APPROVED',
                reviewOpinion: '审核通过'
            }),
            success: function(response) {
                CommonJS.showToast('审核通过', 'success');
                $('#applicationTable').DataTable().ajax.reload();
            }
        });
    });
}

// 审核驳回
function rejectApplication(applicationId) {
    Swal.fire({
        title: '驳回申请',
        text: '请输入驳回理由：',
        input: 'textarea',
        inputPlaceholder: '请输入驳回理由...',
        showCancelButton: true,
        confirmButtonText: '确认驳回',
        cancelButtonText: '取消',
        preConfirm: (reason) => {
            if (!reason) {
                Swal.showValidationMessage('请输入驳回理由');
            }
            return reason;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            CommonJS.ajax({
                url: '/api/scholarships/applications/' + applicationId + '/review',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    reviewStatus: 'REJECTED',
                    reviewOpinion: '审核驳回',
                    rejectedReason: result.value
                }),
                success: function(response) {
                    CommonJS.showToast('申请已驳回', 'success');
                    $('#applicationTable').DataTable().ajax.reload();
                }
            });
        }
    });
}
```

## 9. 配置文件详细设计

### 9.1 Spring Boot应用配置

#### 9.1.1 application.yml主配置文件
```yaml
# 应用程序配置
server:
  port: 8080
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:
  # 应用名称
  application:
    name: scholarship-management-system